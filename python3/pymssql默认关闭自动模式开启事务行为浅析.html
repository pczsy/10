<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修pymssql默认关闭自动模式开启事务行为浅析' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>pymssql默认关闭自动模式开启事务行为浅析</center></div><div class='banquan'>原文出处:本文由博客园博主潇湘隐者提供。<br/>
原文连接:https://www.cnblogs.com/kerrycode/p/11391832.html</div><br>
    <p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><font color="#000000"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt">使用Python采集SQL Server数据库服务器磁盘信息时，遇到了一个错误</font></font></span><font style="font-size: 10.5pt"><span style="line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn; mso-ascii-font-family: 宋体; mso-fareast-font-family: 宋体"><font face="等线">“</font></span><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体">CONFIG statement cannot be used inside a user transaction.DB-Lib error message 20018, severity 16</font></span><span style="line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn; mso-ascii-font-family: 宋体; mso-fareast-font-family: 宋体"><font face="等线">”</font></span></font><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt">，那么为什么遇到这个错误呢？ 其实很简单，就是因为SQL Server事务中不允许使用</font></font></span></font><font face="新宋体"><font color="#0000ff"><span lang="X-NONE" style="font-family: ; color: ; line-height: 15pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 新宋体; mso-font-kerning: 0pt; mso-ansi-language: x-none"><font style="font-size: 10pt">RECONFIGURE</font></span><span style="font-family: ; color: ; line-height: 15pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 新宋体; mso-font-kerning: 0pt; mso-ansi-language: x-none"><font style="font-size: 10pt">，</font></span></font></font><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">我们可以简单模拟构造一下这个错误，如下所示：</font></font></span></p> <p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p> <div id="codeSnippetWrapper" style="overflow: auto; cursor: text; font-size: 11pt; border-top: silver 1px solid; font-family: 'Courier New', courier, monospace; border-right: silver 1px solid; width: 97.5%; border-bottom: silver 1px solid; padding-bottom: 4px; direction: ltr; text-align: left; padding-top: 4px; padding-left: 4px; margin: 20px 0px 10px; border-left: silver 1px solid; line-height: 11pt; padding-right: 4px; max-height: 1200px; background-color: #f4f4f4"> <div id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4"><pre><code><span style="color: #0000ff">BEGIN</span>&nbsp;<span style="color: #0000ff">TRAN</span></pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #0000ff">EXEC</span> sp_configure <span style="color: #006080">'show advanced options'</span>, 1</pre><!--CRLF--><pre><code>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #0000ff">RECONFIGURE</span>&nbsp;<span style="color: #0000ff">WITH</span> OVERRIDE;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4"><span style="color: #0000ff">COMMIT</span>&nbsp;<span style="color: #0000ff">TRAN</span>;</pre><!--CRLF--></div></div>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 新宋体; mso-font-kerning: 0pt; mso-ansi-language: x-none"><font face="新宋体"><font style="font-size: 10pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: 15pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 新宋体; mso-font-kerning: 0pt; mso-ansi-language: x-none"><a href="https://img2018.cnblogs.com/blog/73542/201908/73542-20190821230340196-252080377.png"><img title="clip_image001" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image001" src="./images/pymssql默认关闭自动模式开启事务行为浅析0.png" width="652" height="287"></a></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font color="#000000" face="宋体"></font></span>&nbsp;</p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">我的Python脚本中，访问数据库的SQL没有使用事务（没有BEGIN TRAN ... COMMIT TRAN），那么是否pymssql中默认会开启事务呢？ 我们可以构造一个Python脚本访问SQL Server 数据库，然后我们使用SQL Profile跟踪一下，就基本上能知道是否pymssql会默认开启事务。Python脚本TranTest.py如下所示：</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<div id="codeSnippetWrapper" style="overflow: auto; cursor: text; font-size: 11pt; border-top: silver 1px solid; font-family: 'Courier New', courier, monospace; border-right: silver 1px solid; width: 97.5%; border-bottom: silver 1px solid; padding-bottom: 4px; direction: ltr; text-align: left; padding-top: 4px; padding-left: 4px; margin: 20px 0px 10px; border-left: silver 1px solid; line-height: 11pt; padding-right: 4px; max-height: 1200px; background-color: #f4f4f4">
<div id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4"><pre><code><span style="color: #008000"># -*- coding: utf-8 -*-</span></pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4"><span style="color: #006080">''</span><span style="color: #006080">'</pre><!--CRLF--><pre><code>-------------------------------------------------------------------------------------------</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">--&nbsp; Script Name&nbsp;&nbsp;&nbsp;&nbsp; :&nbsp;&nbsp; TranTest.py</pre><!--CRLF--><pre><code>-------------------------------------------------------------------------------------------</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">'</span><span style="color: #006080">''</span></pre><!--CRLF--><pre><code>import pymssql</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">import logging</pre><!--CRLF--><pre><code>import os.path</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">import os</pre><!--CRLF--><pre><code>import base64</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">from cryptography.fernet import Fernet</pre><!--CRLF--><pre><code>&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre><code>&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre><code>&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">key=bytes(os.environ.get(<span style="color: #006080">'key'</span>),encoding=<span style="color: #006080">"utf8"</span>)</pre><!--CRLF--><pre><code>cipher_suite = Fernet(key)</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">with open(<span style="color: #006080">'/home/konglb/python/conf/ms_db_conf.bin'</span>, <span style="color: #006080">'rb'</span>) as file_object:</pre><!--CRLF--><pre><code>&nbsp;&nbsp;&nbsp; <span style="color: #0000ff">for</span> line <span style="color: #0000ff">in</span> file_object:</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; encryptedpwd = line</pre><!--CRLF--><pre><code>decrypt_pwd = (cipher_suite.decrypt(encryptedpwd))</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">password_decrypted = bytes(decrypt_pwd).decode(<span style="color: #006080">"utf-8"</span>) <span style="color: #008000">#convert to string</span></pre><!--CRLF--><pre><code>env_db_user=os.environ.get(<span style="color: #006080">'db_user'</span>)</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">db_user=base64.b64decode(bytes(env_db_user, encoding=<span style="color: #006080">"utf8"</span>))</pre><!--CRLF--><pre><code>&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre><code>dest_db_conn = pymssql.connect(host=os.environ.get(<span style="color: #006080">'db_host'</span>),</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=bytes.decode(db_user),</pre><!--CRLF--><pre><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; password=password_decrypted,</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database=<span style="color: #006080">'master'</span>,</pre><!--CRLF--><pre><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; charset=<span style="color: #006080">"utf8"</span>);</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre><code>sub_cursor = dest_db_conn.cursor(as_dict=True)</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre><code>&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">sub_cursor.execute(<span style="color: #006080">'SELECT COUNT(*) AS RecordNum FROM msdb.dbo.sysmail_account'</span>)</pre><!--CRLF--><pre><code>result_rows =sub_cursor.fetchone()</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre><code>print(result_rows[<span style="color: #006080">"RecordNum"</span>])</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre><code><span style="color: #008000">#dest_db_conn.commit()</span></pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 11pt; font-family: 'Courier New', courier, monospace; width: 100%; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; border-left-style: none; line-height: 11pt; padding-right: 0px; background-color: #f4f4f4">dest_db_conn.close()</pre><!--CRLF--></div></div>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">如下截图所示，我们发现pymssql会对任何访问SQL Server的SQL加上BEGIN TRAN，也许眼尖的同学发现了端倪，SQL Profile捕获的SQL，有BEGIN TRAN，但是没有COMMIT TRAN，这个是因为上面的Python代码中没有提交事务（#dest_db_conn.commit() 注释了）</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font color="#000000" face="宋体"></font></span>&nbsp;</p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><a href="https://img2018.cnblogs.com/blog/73542/201908/73542-20190821230354694-760818767.png"><img title="clip_image002" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image002" src="./images/pymssql默认关闭自动模式开启事务行为浅析1.png" width="652" height="268"></a></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"></span>&nbsp;</p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; color: ; line-height: 14pt; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 9pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">修改上面Python代码，在关闭数据库连接前，加上一行代码dest_db_conn.commit()，然后重复上面实验就能看到COMMIT TRAN了，如下所示：</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; color: ; line-height: 14pt; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 9pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="background: white; word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">dest_db_conn.commit()<br><span style="line-height: normal; mso-spacerun: yes">&nbsp;&nbsp; </span>dest_db_conn.close()</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; color: ; line-height: 14pt; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 9pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; color: ; line-height: 14pt; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><a href="https://img2018.cnblogs.com/blog/73542/201908/73542-20190821230412492-1191845549.png"><img title="clip_image003" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image003" src="./images/pymssql默认关闭自动模式开启事务行为浅析2.png" width="652" height="348"></a></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font color="#000000" face="宋体"></font></span>&nbsp;</p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">那么pymssql中是否可以关闭事务呢？ 因为有些普通、简单的查询，根本没有必要使用事务，其实pymmsql的Connection接口其实是提供了这么一个功能的，官方文档的介绍如下：</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><b><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Times New Roman"><font style="font-size: 18pt" color="#000000">Connection object methods</font></font></span></b></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">Connection.autocommit(<i>status</i>)</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">Where <i>status</i> is a boolean value. This method turns autocommit mode on or off.</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">By default, autocommit mode is off, what means every transaction must be explicitly committed if changed data is to be persisted in the database.</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">You can turn autocommit mode on, what means every single operation commits itself as soon as it succeeds.</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">A pymssql extension to the DB-API 2.0.</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000" size="3" face="Courier New"></font></span>&nbsp;</p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><font color="#000000"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt">我们知道，SQL Server在默认情况下数据库连接处于自动提交模式(autocommit mode)，每个SQL命令一旦被执行便提交给数据库，一旦提交就无法回滚。 在数据库中不支持事务的情况下，自动提交模式是唯一支持的模式。 在此类数据库语句仅在提交后可以执行它们并没有方法回滚它们;它们因此始终处于自动提交模式.</font></font></span></font></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">那么我们测试一下就会发现autocommit=True的情况下，pymmsql不会自动给SQL加上BEGIN TRAN了（测试期间，犯了个迷糊，弄混了一个前提条件，而且没有充分测试，就做出了一个相反的结论，后续自己一直折腾时才发现这个问题）</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000"><strong>修改前代码：</strong></font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="background: white; word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><font face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000"><font style="font-size: 12pt">dest_db_conn = pymssql.connect(</font></font></span><font style="font-size: 12pt"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">host</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=os.environ.get(</font></span><b><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#008080">'db_host'</font></span></b></font></font><font style="font-size: 12pt"><font face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">),<br><span style="line-height: normal; mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">user</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000080">bytes</font></span></font><font face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">.decode(db_user),<br><span style="line-height: normal; mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">password</font></span></font><font face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=password_decrypted,<br><span style="line-height: normal; mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">database</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=</font></span><b><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#008080">'master'</font></span></b></font></font><font face="Courier New"><font style="font-size: 12pt"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">,<br><span style="line-height: normal; mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">charset</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=</font></span><b><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#008080">"utf8"</font></span></b></font><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font style="font-size: 12pt" color="#000000">);</font></span></font></p>
<p class="MsoNormal" style="background: white; word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000"><strong>修改后代码：</strong></font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><strong><font color="#000000" face="宋体"></font></strong></span>&nbsp;</p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="background: white; word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><font face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000"><font style="font-size: 12pt">dest_db_conn = pymssql.connect(</font></font></span><font style="font-size: 12pt"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">host</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=os.environ.get(</font></span><b><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#008080">'db_host'</font></span></b></font></font><font style="font-size: 12pt"><font face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">),<br><span style="line-height: normal; mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">user</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000080">bytes</font></span></font><font face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">.decode(db_user),<br><span style="line-height: normal; mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">password</font></span></font><font face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=password_decrypted,<br><span style="line-height: normal; mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">database</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=</font></span><b><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#008080">'master'</font></span></b></font></font><font face="Courier New"><font style="font-size: 12pt"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">,<br><span style="line-height: normal; mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">charset</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=</font></span></font><b><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font style="font-size: 12pt" color="#008080">"utf8",</font></span></b></font></p>
<p class="MsoNormal" style="background: white; word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><font face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><span style="line-height: normal; mso-spacerun: yes"><font color="#000000"><font style="font-size: 12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></font></span></span><font style="font-size: 12pt"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#660099">autocommit</font></span><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000000">=</font></span><b><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font color="#000080">True</font></span></b></font><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font style="font-size: 12pt" color="#000000">);</font></span></font></p>
<p class="MsoNormal" style="background: white; word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><font color="#000000" size="3" face="Courier New"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"></span></font>&nbsp;</p>
<p class="MsoNormal" style="background: white; word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; color: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Courier New"><font style="font-size: 12pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">关于pymssql默认情况下会关闭自动提交模式（autocommit mode）开启事务的行为，一定要小心，如果你SQL脚本里面有DML操作而且忘记加commit时，那么可能造成很多不必要的阻塞。而且相信很多不明所以的同学还会一脸懵逼。</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: normal; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><span lang="X-NONE" style="font-family: ; line-height: normal; mso-font-kerning: 0pt; mso-ansi-language: x-none; mso-fareast-font-family: 宋体"><font face="Times New Roman"><font style="font-size: 12pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 0pt; mso-layout-grid-align: none" align="left"><b><span style="font-family: ; line-height: 27pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 18pt" color="#000000">参考资料：</font></font></span></b></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font style="font-size: 10.5pt" color="#000000">&nbsp;</font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><span style="line-height: 16pt; mso-tab-count: 1"><font color="#000000"><font style="font-size: 10.5pt">&nbsp;&nbsp;&nbsp; </font></font></span><u><span style="color: ; line-height: 16pt"><font style="font-size: 10.5pt" color="#0000ff">https://github.com/pymssql/pymssql/issues/460</font></span></u></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font face="宋体"><font color="#000000"><span style="line-height: 16pt; mso-tab-count: 1"><font style="font-size: 10.5pt">&nbsp;&nbsp;&nbsp; </font></span><font style="font-size: 10.5pt"><a href="http://pymssql.org/en/stable/ref/pymssql.html#connection-object-methods">http://pymssql.org/en/stable/ref/pymssql.html#connection-object-methods</a></font></font></font></span></p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"></span>&nbsp;</p>
<p class="MsoNormal" style="word-break: normal; margin: 0cm 0cm 0pt; line-height: 16pt; text-autospace: ; text-indent: 21pt; mso-layout-grid-align: none" align="left"><span style="font-family: ; line-height: 16pt; mso-bidi-font-size: 10.5pt; mso-hansi-font-family: 等线; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt; mso-ansi-language: zh-cn"><font color="#000000" face="宋体"></font></span></p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>