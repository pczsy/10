<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»ä¸œåŒ—å°ç‹ç‹¸æä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/hellxz/p/oauth2_oauthcode_pattern.html</div><br>
    <p>æœ¬æ–‡å¯ä»¥è½¬è½½ï¼Œä½†è¯·æ³¨æ˜å‡ºå¤„https://www.cnblogs.com/hellxz/p/oauth2_oauthcode_pattern.html</p>
<h2 id="å†™åœ¨å‰è¾¹">å†™åœ¨å‰è¾¹</h2>
<p>åœ¨æ–‡ç« <a href="https://www.cnblogs.com/hellxz/p/oauth2_process.html">OAuth 2.0 æ¦‚å¿µåŠæˆæƒæµç¨‹æ¢³ç†</a> ä¸­æˆ‘ä»¬è°ˆåˆ°OAuth 2.0çš„æ¦‚å¿µä¸æµç¨‹ï¼Œè¿™é‡Œæˆ‘å‡†å¤‡åˆ†åˆ«è®°ä¸€è®°è¿™å‡ ç§æˆæƒæ¨¡å¼çš„demoï¼Œä¸€æ–¹é¢ä¸ºè‡ªå·±çš„æœ€è¿‘çš„å­¦ä¹ åšä¸ªæ€»ç»“ï¼Œå¦ä¸€æ–¹é¢åšä¸‹çŸ¥è¯†è¾“å‡ºï¼Œå¦‚æœæ–‡ä¸­æœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œè¯·è¯„è®ºæŒ‡æ­£ï¼Œåœ¨æ­¤ä¸èƒœæ„Ÿæ¿€</p>
<h2 id="å—ä¼—å‰æ">å—ä¼—å‰æ</h2>
<p>é˜…è¯»æœ¬æ–‡ï¼Œé»˜è®¤è¯»è€…å·²ç»è¿‡Spring Securityæœ‰ä¸€å®šçš„äº†è§£ï¼Œå¯¹OAuth2æµç¨‹æœ‰ä¸€å®šäº†è§£</p>
<h2 id="æœ¬æ–‡ç›®æ ‡">æœ¬æ–‡ç›®æ ‡</h2>
<p>å¸¦é¢†è¯»è€…å¯¹Spring Security OAuth2æ¡†æ¶çš„æˆæƒç æ¨¡å¼æœ‰ä¸€ä¸ªæ¯”è¾ƒç›´è§‚çš„æ¦‚å¿µï¼Œèƒ½ä½¿ç”¨æ¡†æ¶æ­å»ºæˆæƒç æ¨¡å¼æˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨ï¼ˆåˆ†ç¦»ç‰ˆæœ¬ï¼‰</p>
<h2 id="æˆæƒç æ¨¡å¼æµç¨‹å›é¡¾">æˆæƒç æ¨¡å¼æµç¨‹å›é¡¾</h2>
<p>æˆæƒç æ¨¡å¼è¦æ±‚ï¼šç”¨æˆ·ç™»å½•å¹¶å¯¹ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆå®¢æˆ·ç«¯ï¼‰è¿›è¡Œæˆæƒï¼Œå‡ºç¤ºæˆæƒç äº¤ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å‡­æˆæƒç æ¢å–access_tokenï¼ˆè®¿é—®å‡­è¯ï¼‰</p>
<p>æ­¤æ¨¡å¼è¦æ±‚æˆæƒæœåŠ¡å™¨ä¸ç”¨æˆ·ç›´æ¥äº¤äº’ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨æ˜¯æ— æ³•è·å–åˆ°ç”¨æˆ·è¾“å…¥çš„å¯†ç ç­‰ä¿¡æ¯çš„ï¼Œè¿™ä¸ªæ¨¡å¼ä¹Ÿæ˜¯OAuth 2.0ä¸­æœ€å®‰å…¨çš„ä¸€ä¸ª</p>
<h2 id="demoåŸºæœ¬ç»“æ„">DemoåŸºæœ¬ç»“æ„</h2>
<p><img src="./images/Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)0.png" /></p>
<p>è¿™é‡Œä¸»è¦å…³æ³¨<code>authorization-code-authorization-server</code>ä¸<code>authorization-code-resource-server</code>è¿™ä¸¤ä¸ªæ¨¡å—</p>
<p>æœ¬æ–‡ä»¥åŠåç»­æ–‡ç« çš„demoå‡æ”¾åœ¨GitHubä¸Šï¼Œæ¬¢è¿å¤§å®¶Star &amp; Forkï¼Œæºç åœ°å€ï¼šhttps://github.com/hellxz/spring-security-oauth2-learn</p>
<blockquote>
<p><code>authorization-code-client-resttemplate-jdbc</code>è¿™ä¸ªé¡¹ç›®æ˜¯ç”¨æ¥æµ‹è¯•éOAuth2æœåŠ¡ä½¿ç”¨RestTemplateä¸JdbcTemplateå¯¹æ¥OAuth2æˆæƒæœåŠ¡çš„ï¼Œæµç¨‹è¿™é‡Œä¸è®²ï¼Œæœ‰å…´è¶£å¯ä»¥debugçœ‹çœ‹ï¼Œå¯èƒ½ä¼šè®©æ‚¨å¯¹æ•´ä¸ªæµç¨‹ä¼šæœ‰æ›´æ¸…æ™°çš„æ„Ÿå—</p>
</blockquote>
<h2 id="mavenä¾èµ–">Mavenä¾èµ–</h2>
<pre><code><code>        &lt;!--Spring Security--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--Spring Boot Starter Web æ‰€æœ‰demoå‡ä½¿ç”¨web--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- Spring Security OAuth2 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt;
            &lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt;
            &lt;version&gt;${spring-security-oauth2.version}&lt;/version&gt;
        &lt;/dependency&gt;</code></pre>
<h2 id="æ­å»ºæˆæƒæœåŠ¡å™¨authorization-server">æ­å»ºæˆæƒæœåŠ¡å™¨ï¼ˆAuthorization Serverï¼‰</h2>
<blockquote>
<p>æ–‡ä¸­æœåŠ¡å™¨å‡ä½¿ç”¨demoçº§åˆ«é…ç½®ï¼Œè¯·å‹¿ç›´æ¥ä½¿ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ</p>
</blockquote>
<p>æˆæƒæœåŠ¡å™¨ç»“æ„ä¸»ä½“å¦‚ä¸‹ï¼š</p>
<p><img src="./images/Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)1.png" /></p>
<hr />
<p>å¯åŠ¨ç±»è‡ªä¸å¤šè¯´ï¼Œå…ˆè¯´ä¸‹SecurityConfig</p>
<pre class="java"><code>package com.github.hellxz.oauth2.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

import java.util.Collections;

@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Bean
    public PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        // @formatter: off
        auth.inMemoryAuthentication()
                .withUser(&quot;hellxz&quot;)
                .password(passwordEncoder().encode(&quot;xyz&quot;))
                .authorities(Collections.emptyList());
        // @formatter: on
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .anyRequest().authenticated() //æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦é€šè¿‡è®¤è¯
                .and()
                .httpBasic() //Basicç™»å½•
                .and()
                .csrf().disable(); //å…³è·¨åŸŸä¿æŠ¤
    }
}
</code></pre>
<p>é€šè¿‡<code>@Configuration</code> å’Œ<code>@EnableWebSecurity</code>å¼€å¯Spring Securityé…ç½®ï¼Œç»§æ‰¿<code>WebSecurityConfigurerAdapter</code>çš„æ–¹æ³•ï¼Œå®ç°ä¸ªæ€§åŒ–é…ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å†…å­˜ä¿å­˜ä¸€ä¸ªåä¸º<code>hellxz</code>ã€å¯†ç ä¸º<code>xyz</code>çš„ç”¨æˆ·ï¼Œä¸æˆæƒæœåŠ¡å™¨äº¤äº’çš„ç”¨æˆ·å°±æ˜¯ä»–äº†</p>
<p>é™¤äº†é…ç½®ç”¨æˆ·ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æœåŠ¡çš„èµ„æºè¿›è¡Œä¿æŠ¤ï¼Œè¿™é‡Œå°†æ‰€æœ‰çš„è¯·æ±‚éƒ½è¦æ±‚é€šè¿‡è®¤è¯æ‰å¯ä»¥è®¿é—®ï¼Œç”¨æˆ·ç™»å½•éœ€è¦ä½¿ç”¨httpBasicå½¢å¼ï¼ˆå°±æ˜¯é‚£ç§ç½‘é¡µå¼¹ä¸ªçª—è¦æ±‚ç™»å½•çš„é‚£ç§ğŸ˜„ï¼‰</p>
<p>Spring Security 5.xç‰ˆæœ¬åï¼Œè¦æ±‚æ˜¾ç¤ºå£°æ˜ä½¿ç”¨çš„å¯†ç å™¨ï¼Œå°±æ˜¯<code>PasswordEncoder</code>äº†ï¼Œå¸¸ç”¨<code>BCryptPasswordEncoder</code>ï¼Œç®€å•çš„å¯ä»¥è®¤ä¸ºå®ƒæ˜¯ä½¿ç”¨æ—¶é—´æˆ³å’Œç›è¿›è¡ŒåŠ å¯†çš„ä¸€ç§ç®—æ³•ï¼ŒåŒä¸€ä¸ªå¯†ç è¢«åŠ å¯†åä¹Ÿä¸ä¼šç›¸åŒ</p>
<hr />
<p>æ¥ç€çœ‹çœ‹<code>æˆæƒæœåŠ¡å™¨çš„é…ç½®</code>ï¼Œ<strong>ç”»é‡ç‚¹</strong></p>
<pre class="java"><code>package com.github.hellxz.oauth2.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;
import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;
import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;
import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;

//æˆæƒæœåŠ¡å™¨é…ç½®
@Configuration
@EnableAuthorizationServer //å¼€å¯æˆæƒæœåŠ¡
public class AuthorizationConfig extends AuthorizationServerConfigurerAdapter {

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public void configure(AuthorizationServerSecurityConfigurer security) throws Exception {
        //å…è®¸è¡¨å•æäº¤
        security.allowFormAuthenticationForClients()
                .checkTokenAccess(&quot;isAuthenticated()&quot;);
    }

    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
        // @formatter: off
        clients.inMemory()
                .withClient(&quot;client-a&quot;) //clientç«¯å”¯ä¸€æ ‡è¯†
                    .secret(passwordEncoder.encode(&quot;client-a-secret&quot;)) //å®¢æˆ·ç«¯çš„å¯†ç ï¼Œè¿™é‡Œçš„å¯†ç åº”è¯¥æ˜¯åŠ å¯†åçš„
                    .authorizedGrantTypes(&quot;authorization_code&quot;) //æˆæƒæ¨¡å¼æ ‡è¯†
                    .scopes(&quot;read_user_info&quot;) //ä½œç”¨åŸŸ
                    .resourceIds(&quot;resource1&quot;) //èµ„æºid
                    .redirectUris(&quot;http://localhost:9001/callback&quot;); //å›è°ƒåœ°å€
        // @formatter: on
    }
}
</code></pre>
<p>1.é€šè¿‡<code>@Configuration</code> å’Œ<code>EnableAuthorizationServer</code>å¼€å¯æˆæƒæœåŠ¡å™¨é…ç½®ï¼Œé€šè¿‡é‡å†™<code>AuthorizationServerConfigurerAdapter</code>çš„æ–¹æ³•æ¥å®Œæˆè‡ªå®šä¹‰æˆæƒæœåŠ¡å™¨</p>
<p>2.OAuth2æˆæƒç æ¨¡å¼ä¸­ï¼Œè¦æ±‚ä¸ä»…ä»…ç”¨æˆ·éœ€è¦ç™»å½•ï¼Œè¿˜è¦æ±‚å®¢æˆ·ç«¯ä¹Ÿéœ€è¦ç™»å½•ï¼Œè¿™é‡Œå°±éœ€è¦åœ¨<code>configure(ClientDetailsServiceConfigurer clients)</code>è¿™ä¸ªæ–¹æ³•ä¸­é…ç½®å®¢æˆ·ç«¯ï¼ˆç¬¬ä¸‰æ–¹åº”ç”¨ï¼‰çš„ç™»å½•ä¿¡æ¯ï¼Œ</p>
<ul>
<li><code>withClient</code>ä¸­é…ç½®çš„æ˜¯å®¢æˆ·ç«¯idï¼ˆclient_idï¼‰</li>
<li>secretä¸ºå®¢æˆ·ç«¯çš„å¯†ç ï¼Œè¦æ±‚ä½¿ç”¨åŠ å¯†å™¨è¿›è¡ŒåŠ å¯†</li>
<li>æˆæƒç çš„authorizedGrantTypeså¿…é¡»é…ç½®æœ‰<code>&quot;authorization_code&quot;</code>ï¼ˆæˆæƒç æ¨¡å¼ï¼‰ï¼Œè¿™é‡Œæ˜¯å¯ä»¥åŒæ—¶æ”¯æŒå¤šç§æˆæƒæ¨¡å¼çš„ï¼Œä¸ºäº†ç®€å•åªå†™ä¸€ä¸ª</li>
<li>scopesï¼Œè¯·æ±‚èµ„æºä½œç”¨åŸŸï¼Œç”¨äºé™åˆ¶å®¢æˆ·ç«¯ä¸ç”¨æˆ·æ— æ³•è®¿é—®æ²¡æœ‰ä½œç”¨åŸŸçš„èµ„æº</li>
<li>resourceIdsï¼Œå¯é€‰ï¼Œèµ„æºidï¼Œå¯ä»¥å¯¹åº”ä¸€ä¸ªèµ„æºæœåŠ¡å™¨ï¼Œä¸ªäººç†è§£ä¸ºæŸä¸ªèµ„æºæœåŠ¡å™¨çš„æ‰€æœ‰èµ„æºæ ‡è¯†</li>
<li>redirectUrisï¼Œå›è°ƒåœ°å€ï¼Œæœ‰ä¸¤ä¸ªä½œç”¨ï¼š1.å›è°ƒå®¢æˆ·ç«¯åœ°å€ï¼Œè¿”å›æˆæƒç ï¼› 2.æ ¡éªŒæ˜¯å¦æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯</li>
</ul>
<blockquote>
<p>redirectUrisæ ¡éªŒæ˜¯å¦åŒä¸€ä¸ªå®¢æˆ·ç«¯è¿™ä¸ªï¼Œå¯èƒ½è¯´çš„ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œè¯´ä¸‹å¤§ä½“æµç¨‹ï¼Œæˆ‘ä»¬åœ¨æˆæƒæœåŠ¡å™¨ä¸Šé…ç½®äº†è¿™ä¸ªå›è°ƒåœ°å€ï¼ŒæˆæƒæœåŠ¡å™¨åœ¨ç”¨æˆ·æˆæƒæˆåŠŸåï¼Œè¿”å›æˆæƒç çš„åœ°å€å°±æ˜¯å®ƒï¼Œå¦å¤–æˆ‘ä»¬åç»­ç”³è¯·tokenæ—¶ï¼Œä¹Ÿéœ€è¦ä¼ é€’è¿™ä¸ªå›è°ƒåœ°å€ï¼Œæ‰€ä»¥æˆ‘çš„ç†è§£æ˜¯æ ¡éªŒæ˜¯å¦æ˜¯åŒä¸€å®¢æˆ·ç«¯å‘æ¥çš„ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆæ¢tokenæ—¶ï¼‰</p>
</blockquote>
<p>3.<code>configure(AuthorizationServerSecurityConfigurer security)</code>è¿™é‡Œé…ç½®èµ„æºå®¢æˆ·ç«¯ï¼ˆç¬¬ä¸‰æ–¹åº”ç”¨ï¼‰çš„è¡¨å•æäº¤æƒé™ï¼Œç±»ä¼¼Spring Securityé…ç½®çš„<code>permitAll()</code>ç­‰æƒé™æ§åˆ¶æ ‡è¯†ï¼Œå¦‚æœä¸é…ç½®ï¼Œå®¢æˆ·ç«¯å°†æ— æ³•æ¢å–token</p>
<hr />
<p>4.<code>application.properties</code></p>
<p>è¿™é‡Œæˆ‘åªé…ç½®äº†server.port=8080</p>
<hr />
<p>è¿™æ ·æˆ‘ä»¬å°±é…ç½®äº†ç›¸å½“ç®€æ˜“çš„æˆæƒæœåŠ¡å™¨ï¼Œ<strong>å¯åŠ¨æµ‹è¯•</strong>ä¸‹</p>
<p><img src="./images/Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)2.png" /></p>
<p><strong>è·å–æˆæƒç çš„æµç¨‹</strong>ï¼Œ<strong>ä¸€èˆ¬æ˜¯ç”±å®¢æˆ·ç«¯ä½¿ç”¨è‡ªå·±çš„client_idä¸å¯†ç +response_type=codeæ‹¼æ¥urlï¼Œè®©æµè§ˆå™¨è·³è½¬å®Œæˆçš„ï¼Œç”¨æˆ·çš„ç™»å½•ä¸æˆæƒè¿‡ç¨‹éƒ½éœ€è¦åœ¨æµè§ˆå™¨ä¸­å®Œæˆ</strong>ï¼Œå¯åŠ¨é¡¹ç›®åè®¿é—®ä¸‹åˆ—url</p>
<p>http://localhost:8080/oauth/authorize?client_id=client-a&amp;client_secret=client-a-secret&amp;response_type=code</p>
<p>ç™»å½•ç”¨æˆ·/å¯†ç ï¼š hellxz/xyz ï¼Œé€‰æ‹©Approveè¡¨ç¤ºæ¥å—æˆæƒï¼ŒDenyåä¹‹ï¼Œå¦‚ä¸‹åŠ¨å›¾æ‰€ç¤º</p>
<p><img src="./images/Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)3.png" /></p>
<p>æœ€åæˆ‘ä»¬å¾—åˆ°äº†å›è°ƒåœ°å€http://localhost:9001/callback?code=2e6450</p>
<p>è¿™é‡Œçš„<strong>codeå°±æ˜¯æˆæƒç </strong>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬<strong>ä½¿ç”¨æˆæƒç è¿›è¡Œæ¢å–token</strong></p>
<p>POSTè¯·æ±‚ï¼Œhttp://localhost:8080/oauth/tokenï¼Œå‚æ•°å¦‚å›¾</p>
<p><img src="./images/Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)4.png" /></p>
<p>BasicAuthï¼šè¿™é‡Œå¡«çš„æ˜¯å®¢æˆ·ç«¯é…ç½®çš„client_idå’Œclient_secretçš„å€¼ï¼Œç›¸å½“äº<code>curl --user client_id:client_secret</code>ï¼Œé…ç½®åä¼šåœ¨Headerä¸­æ·»åŠ <code>Authorization:Basic Y2xpZW50LWE6Y2xpZW50LWEtc2VjcmV0</code>ï¼Œ<code>Basicç©ºæ ¼</code>åçš„æ˜¯<code>client_id:client_secret</code>å…·ä½“å€¼è¢«Base64åå¾—åˆ°çš„å€¼</p>
<p>è¯·æ±‚å‚æ•°åˆ—è¡¨ï¼š</p>
<ul>
<li>code=æˆæƒç </li>
<li>grant_type=authorization_code</li>
<li>redirect_uri=å›è°ƒurl ï¼Œè¦ä¸é…ç½®å¤„å’Œè·å–æˆæƒç å¤„ç›¸åŒ</li>
<li>scope=ä½œç”¨åŸŸ</li>
</ul>
<p>æœ€åæˆ‘ä»¬è·å¾—äº†æˆæƒæœåŠ¡çš„å“åº”ï¼ŒåŒ…å«tokençš„json</p>
<pre class="json"><code>{
    &quot;access_token&quot;: &quot;99435e13-f9fe-438a-a94e-3b00d549b329&quot;, //è®¿é—®token
    &quot;token_type&quot;: &quot;bearer&quot;, //tokenç±»å‹ï¼Œä½¿ç”¨æ—¶éœ€è¦æ‹¼æ¥åœ¨tokenå‰å¹¶åœ¨tokenå‰åŠ ç©ºæ ¼
    &quot;expires_in&quot;: 43199, //è¿‡æœŸæ—¶é—´
    &quot;scope&quot;: &quot;read_user_info&quot; //ä½œç”¨åŸŸ
}</code></pre>
<p>åœ¨access_tokenæœªè¿‡æœŸä¹‹å‰ï¼ŒåŒä¸€ä¸ªç”¨æˆ·åä½¿ç”¨åŒä¸€ä¸ªå®¢æˆ·ç«¯è®¿é—®éƒ½ä¼šæ˜¯åŒä¸€ä¸ªaccess_token</p>
<p>æˆæƒæœåŠ¡å™¨å…ˆæ”¾åœ¨è¿™é‡Œï¼Œä¸è¦å…³æœï¼Œæ¥ä¸‹æ¥æ­å»ºèµ„æºæœåŠ¡å™¨</p>
<h2 id="æ­å»ºèµ„æºæœåŠ¡å™¨resource-server">æ­å»ºèµ„æºæœåŠ¡å™¨ï¼ˆResource Serverï¼‰</h2>
<p>èµ„æºæœåŠ¡å™¨ç»“æ„</p>
<p><img src="./images/Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)5.png" /></p>
<p>å…¥å£ç±»ä¸å¤šè¯´ï¼Œå…ˆæ­å»ºèµ„æºæœåŠ¡å™¨ä¸»è¦é…ç½®ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨<code>ResourceConfig</code>è¿›è¡Œé…ç½®</p>
<pre class="java"><code>package com.github.hellxz.oauth2.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;
import org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;
import org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;
import org.springframework.security.oauth2.provider.token.RemoteTokenServices;

@Configuration
@EnableResourceServer
public class ResourceConfig extends ResourceServerConfigurerAdapter {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Primary
    @Bean
    public RemoteTokenServices remoteTokenServices() {
        final RemoteTokenServices tokenServices = new RemoteTokenServices();
        //è®¾ç½®æˆæƒæœåŠ¡å™¨check_tokenç«¯ç‚¹å®Œæ•´åœ°å€
        tokenServices.setCheckTokenEndpointUrl(&quot;http://localhost:8080/oauth/check_token&quot;);
        //è®¾ç½®å®¢æˆ·ç«¯idä¸secretï¼Œæ³¨æ„ï¼šclient_secretå€¼ä¸èƒ½ä½¿ç”¨passwordEncoderåŠ å¯†ï¼
        tokenServices.setClientId(&quot;client-a&quot;);
        tokenServices.setClientSecret(&quot;client-a-secret&quot;);
        return tokenServices;
    }

    @Override
    public void configure(HttpSecurity http) throws Exception {
        //è®¾ç½®åˆ›å»ºsessionç­–ç•¥
        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED);
        //@formatter:off
        //æ‰€æœ‰è¯·æ±‚å¿…é¡»æˆæƒ
        http.authorizeRequests()
                .anyRequest().authenticated();
        //@formatter:on
    }

    @Override
    public void configure(ResourceServerSecurityConfigurer resources) {
        resources.resourceId(&quot;resource1&quot;).stateless(true);
    }
}
</code></pre>
<p>1.é€šè¿‡<code>@Configuration</code> å’Œ<code>@EnableResourceServer</code>è¿™ä¸¤ä¸ªæ³¨è§£æ ‡è¯†æœåŠ¡æ˜¯ä¸€ä¸ªèµ„æºæœåŠ¡å™¨ï¼Œé‡å†™<code>ResourceServerConfigurerAdapter</code>æ¥å®ç°è‡ªå®šä¹‰æˆæƒæœåŠ¡å™¨</p>
<p>2.é…ç½®<code>configure(HttpSecurity http)</code>æ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥ä»£æ›¿Spring SecurityåŒåæ–¹æ³•é…ç½®ï¼Œå¼€å¯æ‰€æœ‰è¯·æ±‚éœ€è¦æˆæƒæ‰å¯è®¿é—®</p>
<p>3.é…ç½®èµ„æºç›¸å…³è®¾ç½®<code>configure(ResourceServerSecurityConfigurer resources)</code>ï¼Œè¿™é‡Œåªè®¾ç½®<code>resourceId</code></p>
<p><em>åç»­çš„ä½¿ç”¨redisæ ¡éªŒtokenä¹Ÿåœ¨è¿™é‡Œè®¾ç½®</em></p>
<p>4.æ ¡éªŒtokençš„é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨äº†è¿œç¨‹è°ƒç”¨æˆæƒæœåŠ¡å™¨å¸®å¿™æ ¡éªŒtokençš„æ–¹å¼ï¼Œåªéœ€è¦æ˜¾ç¤ºæ³¨å…¥<code>RemoteTokenServices remoteTokenServices()</code>çš„Beanï¼Œå°±å¯ä»¥è°ƒç”¨æˆæƒæœåŠ¡å™¨çš„/oauth/check_tokenç«¯ç‚¹ï¼Œè®¾ç½®å®¢æˆ·ç«¯é…ç½®çš„å€¼ï¼Œè¯¦è§æ³¨é‡Š</p>
<hr />
<p>è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±é…ç½®å¥½äº†èµ„æºæœåŠ¡å™¨ï¼Œå½“ç„¶å…‰æœ‰é…ç½®æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬æä¸€ä¸ªèµ„æºæ¥å£åšæµ‹è¯•ç”¨</p>
<p>ä¸Šè¾¹çš„<code>ResourceController</code>ä¸<code>UserVO</code>éƒ½æ¯”è¾ƒç®€å•ï¼Œä¼ å…¥ä¸€ä¸ªåç§°ï¼Œè¿”å›ç”¨æˆ·å¯¹è±¡ï¼ŒåŒ…å«ç”¨æˆ·åå’Œé‚®ç®±ä¿¡æ¯</p>
<pre class="java"><code>package com.github.hellxz.oauth2.web.controller;

import com.github.hellxz.oauth2.web.vo.UserVO;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class ResourceController {

    @GetMapping(&quot;/user/{username}&quot;)
    public UserVO user(@PathVariable String username){
        return new UserVO(username, username + &quot;@foxmail.com&quot;);
    }
}
</code></pre>
<pre class="java"><code>package com.github.hellxz.oauth2.web.vo;

public class UserVO {
    private String username;
    private String email;

    public UserVO(String username, String email) {
        this.username = username;
        this.email = email;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }
}
</code></pre>
<hr />
<p>application.propertiesä¸­é…ç½®äº†ä¸æˆæƒæœåŠ¡å™¨ä¸åŒçš„ç«¯å£ï¼š8081</p>
<p><code>server.port=8081</code></p>
<hr />
<p><strong>å¯åŠ¨èµ„æºæœåŠ¡æµ‹è¯•</strong></p>
<p>ä»€ä¹ˆä¹Ÿä¸ä¼ ï¼Œç›´æ¥è®¿é—®æ¥å£ï¼Œæç¤ºèµ„æºéœ€è¦æˆæƒ</p>
<p><img src="./images/Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)6.png" /></p>
<p>å¤åˆ¶ä¹‹å‰è·å–åˆ°çš„tokenï¼Œæ·»åŠ tokenè®¿é—®æ¥å£http://localhost:8081/user/hellxz001</p>
<p><img src="./images/Spring Security OAuth2 Demo â€”â€” æˆæƒç æ¨¡å¼ (Authorization Code)7.png" /></p>
<p>Bearer Tokenç›¸å½“äºåœ¨Headersä¸­æ·»åŠ <code>Authorizationï¼šBearerç©ºæ ¼access_token</code></p>
<p>è‡³æ­¤æˆ‘ä»¬æˆåŠŸçš„æ­å»ºå¹¶æµ‹è¯•äº†æˆæƒç æ¨¡å¼ä¸‹çš„æœ€ç®€å•çš„æˆæƒæœåŠ¡ä¸èµ„æºæœåŠ¡åˆ†ç¦»çš„demo</p>
<h2 id="å°¾å£°">å°¾å£°</h2>
<p>æˆæƒç æ¨¡å¼å°±å…ˆåœ¨è¿™é‡Œå‘Šä¸€æ®µè½ï¼Œå†™çš„æ¯”è¾ƒåŸºç¡€ï¼Œè‡ªè®¤ä¸ºè¯¥è¯´åˆ°çš„ç‚¹éƒ½è¯´åˆ°äº†ï¼Œåç»­è¿˜ä¼šå†™å…¶å®ƒæ¨¡å¼çš„æ–‡ç« ï¼Œå¦‚æ–‡ä¸­æœ‰ä½•é—æ¼ï¼Œè¯·ä¸åè¯„è®ºåé¦ˆï¼Œæœ¬äººä¼šå°½å¿«æ”¹æ­£ï¼Œè°¢è°¢</p>
<p>æœ¬æ–‡ä»¥åŠåç»­æ–‡ç« çš„demoå‡æ”¾åœ¨GitHubä¸Šï¼Œæ¬¢è¿å¤§å®¶Star &amp; Forkï¼Œæºç åœ°å€ï¼šhttps://github.com/hellxz/spring-security-oauth2-learn ï¼ŒDemoä¸­çš„READMEæ–‡æ¡£å†™å¾—æ¯”è¾ƒè¯¦ç»†ï¼Œä¹Ÿå¯å ªä¸€çœ‹</p>
<p>æœ¬æ–‡å¯ä»¥è½¬è½½ï¼Œä½†è¯·æ³¨æ˜å‡ºå¤„https://www.cnblogs.com/hellxz/p/oauth2_oauthcode_pattern.html</p>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>