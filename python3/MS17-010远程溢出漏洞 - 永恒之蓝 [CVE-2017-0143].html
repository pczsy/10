<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]</center></div><div class='banquan'>原文出处:本文由博客园博主Mirror王宇阳提供。<br/>
原文连接:https://www.cnblogs.com/wangyuyang1016/p/12099333.html</div><br>
    <h1 id="ms17-010远程溢出漏洞永恒之蓝">MS17-010远程溢出漏洞(<a href="https://baike.baidu.com/item/MS17-010/20800008?fr=aladdin">永恒之蓝</a>)</h1>
<blockquote>
<p>Ti:2019-12-25</p>
<p>By:Mirror王宇阳</p>
<p>MS17-010 CVE-2017-0143</p>
<p>MS17-010 CVE-2017-0144</p>
<p>MS17-010 CVE-2017-0145</p>
<p>MS17-010 CVE-2017-0146</p>
<p>MS17-010 CVE-2017-0148</p>
</blockquote>
<h2 id="实验准备">实验准备</h2>
<h3 id="漏洞原理"><a href="https://blog.csdn.net/qq_27446553/article/details/73480807">漏洞原理</a></h3>
<p>MS17-010漏洞出现在Windows SMB v1中的内核态函数<code>srv!SrvOs2FeaListToNt</code>在处理<code>FEA</code>(File Extended Attributes)转换时，在大非分页池(Large Non-Paged Kernel Pool)上存在缓冲区溢出。</p>
<p>函数<code>srv!SrvOs2FeaListToNt</code>在将<code>FEA</code> list转换成<code>NTFEA</code>(Windows NT FEA) list前会调用<code>srv!SrvOs2FeaListSizeToNt</code>去计算转换后的FEA lsit的大小，因计算大小错误，而导致缓冲区溢出。</p>
<h3 id="漏洞历史">漏洞历史</h3>
<ul>
<li><p>2017-03-12，微软发布<a href="http://wangshuo.jb51.net:81/201905/tools/ms17010_jb51.rar">MS17-010补丁包</a></p></li>
<li><p>2017-03-14，发布《MS17-010：Windows SMB 服务器<a href="https://support.microsoft.com/zh-cn/help/4012598/title">安全更新说明</a>》</p></li>
<li><p>2017-04-14，Shadowbroker发布漏洞利用工具</p></li>
<li><p>2017-05-12晚上20 时左右，全球爆发永恒之蓝勒索病毒</p></li>
</ul>
<h3 id="机器环境">机器环境</h3>
<ul>
<li>Kali 【攻击机】 192.168.2.196</li>
<li>Win7 【靶子机】 192.168.2.155</li>
</ul>
<h3 id="靶机环境">靶机环境</h3>
<ul>
<li><p>Windows7 专业版</p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]0.png" /></p></li>
<li><p>漏洞的产生</p>
<p>Sbm服务 445端口</p></li>
</ul>
<h2 id="实施漏洞">实施漏洞</h2>
<h3 id="目标扫描">目标扫描</h3>
<ul>
<li><p>使用Nessus对目标机进行扫描，结果如下：</p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]1.png" /></p></li>
<li><p>nmap扫描目标服务：</p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]2.png" /></p></li>
</ul>
<h3 id="二次确认漏洞">二次确认漏洞</h3>
<ul>
<li><p>使用msf的auxiliary二次判断是否存在“MS17-010”漏洞</p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]3.png" /></p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]4.png" /></p>
<p>看见<strong>“Host is likely VULNERABLE to MS17-010(主机可能易受MS17-010攻击)”</strong>可以断定目标机存在该漏洞！</p></li>
</ul>
<h3 id="执行渗透">执行渗透</h3>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]5.png" /></p>
<p>上面就是可以利用的漏洞模块:</p>
<ul>
<li><p><strong>exploit/windows/smb/ms17_010_eternalblue</strong>【<strong><u>成 功</u></strong>】<img src="MS17-010%20永恒之蓝.assets/1577276079109.png" alt="1577276079109" /></p></li>
<li><p><strong>exploit/windows/smb/ms17_010_eternalblue_win8+</strong>【系统不符】</p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]7.png" /></p></li>
<li><p><strong>exploit/windows/smb/ms17_010_psexec</strong>【无效】</p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]8.png" /></p></li>
</ul>
<h3 id="配置payloads">配置Payloads</h3>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]9.png" /></p>
<p>如上图，当前exploit支持的Payload都在上面；</p>
<p>载入“reverse_tcp”，建立meterpreter会话</p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]10.png" /></p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]11.png" /></p>
<p>ps：建立会话后，有大概会导致目标机自动重启</p>
<h2 id="修复策略">修复策略</h2>
<h3 id="漏洞自查">漏洞自查</h3>
<pre><code><code>&gt; systeminfo | findstr KB40</code></pre>
<p>执行上述命令会返回系统补丁包的编号（盗版的嘛~~嘻嘻参考下面的表）</p>
<p><img src="./images/MS17-010远程溢出漏洞 - 永恒之蓝 [CVE-2017-0143]12.png" /></p>
<h3 id="补丁修复">补丁修复</h3>
<ul>
<li><p>下载补丁地址<br />
<a href="http://www.catalog.update.microsoft.com/search.aspx?q=补丁编号" class="uri">http://www.catalog.update.microsoft.com/search.aspx?q=补丁编号</a></p></li>
<li><p>添加系统的入站规则；关闭<u>445、135、138、139</u>等端口</p></li>
</ul>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>