<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»Xiao24æä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/xiao24/p/docker_jenkins_dotnetcore3.html</div><br>
    <h1 id="section"></h1>
<h2 id="å‡†å¤‡å·¥ä½œ">1ã€å‡†å¤‡å·¥ä½œ</h2>
<h3 id="ç¯å¢ƒ">ç¯å¢ƒ</h3>
<ul>
<li>æœ¬åœ°ï¼š <code>Windows</code>ã€<code>Docker</code></li>
<li>ä»£ç ä»“åº“ï¼š<code>Git</code></li>
<li>æœåŠ¡å™¨ï¼š<code>Linux</code>ã€<code>Docker</code></li>
</ul>
<h3 id="å‰æå‡†å¤‡">å‰æå‡†å¤‡</h3>
<ol>
<li><p>åˆ›å»ºä¸ªæœ‰<code>dockerfile</code>æ–‡ä»¶çš„<code>dotnet core 3 web</code>é¡¹ç›®<br />
æ–°å»ºä¸€ä¸ªdotnet 3.0çš„webé¡¹ç›®ï¼Œåœ¨é¡¹ç›®æ–‡ä»¶å¤¹æ·»åŠ Dockerfileæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code><code>FROM mcr.microsoft.com/dotnet/core/aspnet:3.1-buster-slim AS base
WORKDIR /app
EXPOSE 80
COPY . .
ENTRYPOINT [&quot;dotnet&quot;, &quot;WebApplication.dll&quot;]</code></pre></li>
<li>å‡†å¤‡gitä»“åº“ï¼Œå°†é¡¹ç›®çš„ä»£ç ä¸Šä¼ ä¸Šå»</li>
<li><p>æ„å»ºæœ‰<code>dotnet core 3.0 ç¯å¢ƒ</code>çš„<code>jenkins</code></p>
<pre><code><code>FROM jenkins/jenkins:lts
# åˆ‡æ¢rootç”¨æˆ·å®‰è£…ä¸œè¥¿
USER root
# Show distro information!
RUN uname -a &amp;&amp; cat /etc/*release
RUN apt-get update
RUN apt-get install -y curl libunwind8 gettext apt-transport-https
RUN curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor &gt; microsoft.gpg
RUN mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
RUN sh -c &#39;echo &quot;deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-debian-stretch-prod stretch main&quot; &gt; /etc/apt/sources.list.d/dotnetdev.list&#39;
RUN apt-get update
RUN apt-get install -y dotnet-sdk-3.1
# åˆ‡æ¢å›æ¥jenkinsç”¨æˆ·
USER jenkins</code></pre></li>
</ol>
<p>å› ä¸ºjenkinsé‡Œé¢æ˜¯æ²¡æœ‰dotnetcoreç¯å¢ƒçš„,æ‰€ä»¥éœ€è¦æœ¬åœ°åˆ›å»ºä¸ªæ”¯æŒdotnetcoreç¯å¢ƒçš„ã€‚<br />
æ‰¾ä¸ªåœ°æ–¹æ–°å»ºæ–‡ä»¶å¤¹ï¼Œåˆ›å»ºdockerfileæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸Šã€‚</p>
<ol>
<li><p>buildé•œåƒå¹¶è¿è¡Œå®¹å™¨</p>
<pre><code><code>docker build . -t jenkins_dotnet</code></pre>
<blockquote>
<p>è¿™é‡Œç­‰å¾…æ—¶é—´ä¼šæ¯”è¾ƒé•¿~</p>
</blockquote>
<pre><code><code># è¿è¡Œåˆšåˆšæ„å»ºå¥½çš„å®¹å™¨
docker run -d  --name jenkins -p 8080:8080 jenkins_dotnet</code></pre></li>
<li><p>æ‰“å¼€jenkinsï¼Œå®‰è£…æ¨èæ’ä»¶<br />
æ‰“å¼€ <a href="http://localhost:8080">localhost:8080</a> ,å¯ä»¥çœ‹åˆ°<br />
<img style="width:500px;" src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š0.png"/></p>
<pre><code><code>docker exec -it jenkins bash
dotnet --version
cat /var/jenkins_home/secrets/initialAdminPassword</code></pre>
<p><img style="width:500px;" src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š1.png" /></p>
<p>æŠŠå¯†ç å¤åˆ¶å‡ºæ¥ç™»å½•ï¼Œç‚¹å‡»<code>å·¦è¾¹æŒ‰é’®</code>å®‰è£…æ¨èæ’ä»¶<br />
<img style="width:500px;" src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š2.png" /></p>
<blockquote>
<p>è¿™é‡Œæ—¶é—´ä¹Ÿä¼šæ¯”è¾ƒé•¿ï¼Œå¦‚æœæœ‰éƒ¨åˆ†å®‰è£…å¤±è´¥äº†ï¼Œç­‰å‰©ä½™çš„å®‰è£…å®Œåç‚¹å‡»é‡è¯•å³å¯,å¦‚æœæœåŠ¡å™¨ä¸Šè¿˜æ²¡æœ‰dockerï¼Œç°åœ¨å¯ä»¥å»è£…ä¸‹ï¼Œè£…äº†çš„ä¹Ÿå¯ä»¥è¿ä¸ŠæœåŠ¡å™¨ï¼Œå»æ‰§è¡Œ<code>docker pull mcr.microsoft.com/dotnet/core/aspnet:3.1-buster-slim</code>æ‹‰å–ä¸‹dotnet core 3.1çš„é•œåƒï¼Œç­‰ä¼šåˆ›å»ºé•œåƒçš„æ—¶å€™å°±ä¼šå¿«ä¸€ç‚¹å•¦</p>
</blockquote>
<p>æ’ä»¶å®‰è£…å®Œåï¼Œä¼šæœ‰ä¸€äº›åˆ›å»ºç®¡ç†å‘˜å’Œåœ°å€é…ç½®ï¼Œæä¸€ä¸‹å§ã€‚<br />
<img style="width:500px;" src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š3.png" /></p>
<blockquote>
<p>å¦‚æœæœ‰æ’ä»¶å®‰è£…å¤±è´¥ï¼Œç‚¹è¿‡é‡è¯•å®‰è£…æ’ä»¶çš„ï¼Œç°åœ¨éœ€è¦<code>docker restart jenkins</code>é‡å¯ä¸‹åº”ç”¨ï¼Œç„¶åé‡æ–°æ‰“å¼€<a href="http://localhost:8080">localhost:8080</a>ä½¿ç”¨åˆ›å»ºçš„ç®¡ç†å‘˜ç™»å½•ã€‚</p>
</blockquote></li>
</ol>
<h2 id="æå¥½äº†å¼€å§‹å¹²æ´»">2ã€æå¥½äº†ï¼Œå¼€å§‹å¹²æ´»</h2>
<h3 id="å“¦è¿˜æœ‰äº›éœ€è¦å®‰è£…çš„æ’ä»¶-.">å“¦ï¼Œè¿˜æœ‰äº›éœ€è¦å®‰è£…çš„æ’ä»¶ =.=||</h3>
<p>éœ€è¦å®‰è£…çš„æ’ä»¶ï¼š</p>
<ul>
<li>SCP publisher</li>
<li>Publish Over SSH<br />
</li>
<li>Environment Injector</li>
</ul>
<p>è¿›å…¥ ç³»ç»Ÿç®¡ç†&gt;æ’ä»¶ç®¡ç†-&gt;å¯é€‰æ’ä»¶-&gt;è¾“å…¥æ’ä»¶åç§°-&gt;å‹¾é€‰éœ€è¦æ’ä»¶-&gt;ç‚¹å‡»å®‰è£…</p>
<p>å®‰è£…å®Œåï¼Œè®¾ç½®ä¸‹è¿™äº›æ’ä»¶ï¼Œè¿›å…¥ç³»ç»Ÿç®¡ç†-&gt;ç³»ç»Ÿé…ç½®ï¼Œ</p>
<ol>
<li><p><code>SCP publisher</code>è®¾ç½®<br />
Ctrl + F æœä¸‹ <code>SCP</code>æ‰¾åˆ°<code>SCP repository hosts</code>-<code>SCP sites</code>è®¾ç½®ä½ç½®,ç‚¹<code>æ–°å¢</code><br />
HostName: æœåŠ¡å™¨IPåœ°å€<br />
Portï¼šç«¯å£ï¼Œé»˜è®¤22ã€<br />
Root Repository Pathï¼šæ–‡ä»¶å­˜æ”¾ç›®å½•<br />
User Name:ç™»å½•ç”¨æˆ·å<br />
Password/Passphraseï¼šå¯†ç <br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š4.png" /></p></li>
<li><p><code>Publish Over SSH</code> è®¾ç½®<br />
Ctrl + F æœä¸‹ <code>SCP</code>æ‰¾åˆ°<code>SCP repository hosts</code>-<code>SSH Server</code>è®¾ç½®ä½ç½®,ç‚¹<code>æ–°å¢</code>å†ç‚¹<code>é«˜çº§</code>ï¼Œ<strong>å‹¾é€‰ä¸Š <code>Use password authentication, or use a different key</code></strong><br />
Nameï¼šåç§°<br />
Hostnameï¼šæœåŠ¡å™¨IPåœ°å€<br />
Usernameï¼šç™»å½•ç”¨æˆ·å<br />
Remote Directoryï¼šè¿œç¨‹ç›®å½•<br />
Passphrase / Passwordï¼šå¯†ç <br />
Portï¼šè¿æ¥ç«¯å£ï¼ˆé»˜è®¤22ï¼‰<br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š5.png" /></p></li>
</ol>
<blockquote>
<p><strong>é…ç½®å®Œååˆ«å¿˜è®°ç‚¹ä¿å­˜ã€‚</strong></p>
</blockquote>
<h3 id="åˆ›å»ºæ„å»ºä»»åŠ¡ç¬¬ä¸€ç§è‡ªç”±é£æ ¼çš„è½¯ä»¶é¡¹ç›®">åˆ›å»ºæ„å»ºä»»åŠ¡ç¬¬ä¸€ç§ï¼šè‡ªç”±é£æ ¼çš„è½¯ä»¶é¡¹ç›®</h3>
<p>ç‚¹å‡»<code>æ–°å»ºä»»åŠ¡</code>, é€‰æ‹©<code>æ„å»ºä¸€ä¸ªè‡ªç”±é£æ ¼çš„è½¯ä»¶é¡¹ç›®</code><br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š6.png" /></p>
<ol>
<li><p>æºç ç®¡ç†è®¾ç½®<br />
é€‰æ‹©Gitï¼Œåœ¨<code>Repository URL</code>å¡«å…¥Gitä»“åº“åœ°å€<br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š7.png" /></p></li>
<li><p>è§¦å‘æ„å»ºå™¨<br />
å¯ä»¥é…ç½®ä¸€äº›å®šæ—¶æ„å»ºç­‰ï¼Œæˆ‘è¿™é‡Œåªæ˜¯æµ‹è¯•æ‰€ä»¥æ²¡æœ‰é€‰æ‹©è§¦å‘å™¨ã€‚<br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š8.png" /></p></li>
<li>æ„å»ºç¯å¢ƒ
<ol>
<li>å‹¾é€‰<code>Delete workspace before build starts</code></li>
<li>å‹¾é€‰Inject environment variables to the build processï¼Œå­˜æ”¾æ„å»ºæ˜¯éœ€è¦ç”¨åˆ°çš„ç¯å¢ƒå˜é‡<br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š9.png" /></li>
</ol></li>
<li><p>æ„å»º- æ·»åŠ æ‰§è¡Œshellæ­¥éª¤<br />
å¢åŠ æ„å»ºæ­¥éª¤-æ‰§è¡Œshellï¼Œè„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code><code>#åˆ‡æ¢ç›®å½•
cd ./WebApplication
#è¿˜åŸnugetåŒ…
dotnet restore
#ç¼–è¯‘
dotnet build
#åˆ é™¤ä¹‹å‰å‘å¸ƒæ–‡ä»¶
cd ./bin
rm -rf web-publish
rm -f web-publish.tar
cd ..
#å‘å¸ƒ
dotnet publish -o ./bin/web-publish
#åˆ é™¤é…ç½®æ–‡ä»¶
cd ./bin/web-publish
cp ../../Dockerfile .
rm -rf config
cd ..
#å‹ç¼©
tar -cvf web-publish.tar web-publish </code></pre></li>
<li>æ„å»ºåæ­¥éª¤
<ol>
<li><p>ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨<br />
<code>å¢åŠ æ„å»ºåæ“ä½œæ­¥éª¤</code>-é€‰æ‹©<code>Publish artifacts to SCP Repository</code> ,å¡«å…¥éœ€è¦ä¸Šä¼ çš„å‹ç¼©æ–‡ä»¶<br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š10.png" /><br />
è¿™é‡Œæ–‡ä»¶ç›®å½•çš„åŸºç¡€ç›®å½•æ˜¯workspaceï¼Œå¦‚æœä¸çŸ¥é“å…·ä½“çš„åœ°å€ï¼Œå¯ä»¥å…ˆä¸åˆ›å»ºæ„å»ºåæ­¥éª¤ä¿å­˜ä¸‹ï¼Œç„¶åç‚¹å‡»ç«‹å³æ„å»ºï¼Œç­‰å¾…æˆåŠŸåï¼Œç‚¹å‡»å·¥ä½œç©ºé—´çœ‹ä¸‹æ–‡ä»¶è·¯å¾„æ˜¯æ€æ ·çš„ï¼Œæ¯”å¦‚æˆ‘çš„æ˜¯è¿™æ ·çš„ï¼š<br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š11.png" /><br />
å¾—åˆ°å‹ç¼©æ–‡ä»¶ç›®å½•æ˜¯<code>WebApplication/bin/web-publish.tar</code></p></li>
<li><p>æ·»åŠ  æœåŠ¡å™¨ä¸Šè¦æ‰§è¡Œçš„shllå‘½ä»¤ æ­¥éª¤</p></li>
</ol>
<p><code>å¢åŠ æ„å»ºåæ“ä½œæ­¥éª¤</code>- é€‰æ‹© <code>Send build artifacts over SSH</code></p>
<p>è¿™é‡Œè¦æ–°å¢ä¸¤ä¸ªTransfers Setï¼Œåœ¨ç¬¬ä¸€ä¸ª<code>Transfers</code>çš„<code>Exec command</code>è¾“å…¥åˆ›å»ºé•œåƒè„šæœ¬ï¼š</p>
<pre><code><code># å·¥ä½œç›®å½•
WORK_DIR=&quot;/root/publish/WebApplication&quot;;
cd ${WORK_DIR}
# åˆ é™¤åŸæœ‰å‘å¸ƒæ–‡ä»¶å¤¹
rm -rf web-publish;
# è§£å‹
tar -xvf web-publish.tar;
#åˆ é™¤æ–‡ä»¶å‹ç¼©åŒ…
rm -f web-publish.tar;
#åˆ‡æ¢ç”Ÿæˆç›®å½•
cd web-publish/
#å¤‡ä»½é•œåƒ
#åœæ­¢å®¹å™¨
docker stop ${DOCKER_CONTAINER_NAME};
#åˆ é™¤å®¹å™¨
docker rm ${DOCKER_CONTAINER_NAME};
#åˆ é™¤é•œåƒ
docker rmi $(docker images | grep ${DOCKER_IMAGE_NAME});
#åˆ›å»ºé•œåƒ
docker build -t ${DOCKER_IMAGE_NAME} ./;</code></pre>
<p>åœ¨ç¬¬äºŒä¸ª<code>Transfers</code>çš„<code>Exec command</code>ï¼Œè¾“å…¥è¿è¡Œå®¹å™¨å‘½ä»¤ï¼š</p>
<pre><code><code># è¿è¡Œå®¹å™¨
docker run -d -p 8001:80 --name  ${DOCKER_CONTAINER_NAME}  ${DOCKER_IMAGE_NAME}</code></pre>
<p><img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š12.png" /></p>
<blockquote>
<p>åˆ°è¿™é‡Œæ‰€æœ‰çš„è®¾ç½®éƒ½å·²ç»æå¥½å•¦ï¼Œ<code>åˆ«å¿˜è®°ç‚¹å‡»ä¿å­˜</code>ï¼Œç‚¹å‡»<code>ç«‹å³æ„å»º</code> æµ‹è¯•ä¸€ä¸‹å§~</p>
</blockquote></li>
</ol>
<h3 id="åˆ›å»ºæ„å»ºä»»åŠ¡ç¬¬äºŒç§æµæ°´çº¿pipeline">åˆ›å»ºæ„å»ºä»»åŠ¡ç¬¬äºŒç§ï¼šæµæ°´çº¿[pipeline]</h3>
<blockquote>
<p>TODO:è¯„è®ºæœ‰ä½å“¥æ¨èæµæ°´çº¿ å¯è§†åŒ–ä¼šå¥½ä¸€ç‚¹ï¼Œé©¬ä¸ŠåŠ¨æ‰‹å°è¯•ä¸‹~</p>
</blockquote>
<p>é¦–å…ˆåˆ›å»ºä»»åŠ¡ï¼Œé€‰æ‹©æµæ°´çº¿ï¼š<br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š13.png" /></p>
<p>ä¸è‡ªç”±é£æ ¼çš„ä¸€æ ·ä¹Ÿæœ‰è§¦å‘å™¨ã€‚<br />
<img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š14.png" /></p>
<blockquote>
<p>ç„¶åå°±æ²¡çœ‹åˆ°æœ‰å…¶ä»–è®¾ç½®æœ‰ç‚¹æ‡µ ğŸ˜„ ~ç™¾åº¦äº†ä¸‹å‘ç°æµæ°´çº¿ä¸»è¦æ˜¯ç”¨è„šæœ¬å†™çš„</p>
</blockquote>
<p>ç²—ç•¥ç ”ç©¶ä¸‹æµæ°´çº¿è¯­æ³•ï¼Œç„¶ååœ¨ç½‘ä¸Šæ‰¾äº†ä¸ª <a href="https://jenkins.io/blog/2019/02/06/ssh-steps-for-jenkins-pipeline/">SSH Pipeline Steps</a> æµæ°´çº¿æ’ä»¶, å¯ä»¥ä»¥SSHæ–¹å¼ç™»å½•è¿œç¨‹æœºå™¨ï¼Œé›†sshCommandã€sshPutã€sshGet ã€sshRemoveç­‰åŠŸèƒ½ï¼Œå¾ˆç¬¦åˆæˆ‘çš„éœ€æ±‚~åˆ°æ’ä»¶ç®¡ç†å®‰è£…ä¸‹~</p>
<p>ç„¶ååŠæ‡‚ä¸æ‡‚çš„å¼€å§‹æ’¸è„šæœ¬ï¼Œä¸è¿‡åŸºæœ¬ä¸Šå°±æ˜¯æŠŠè‡ªç”±é£æ ¼çš„è„šæœ¬å¤åˆ¶è¿‡æ¥ï¼ŒæŒ‰ç…§æµæ°´çº¿è„šæœ¬çš„é£æ ¼ï¼Œä»¥åŠé…åˆè¿™ä¸ªæ’ä»¶ä¿®æ”¹ä¸‹ã€‚</p>
<p>æµæ°´çº¿è„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code><code>def getHost(){
    def remote = [:]
    remote.name = &#39;aliyun-1&#39;
    remote.host = &#39;ä½ çš„æœåŠ¡å™¨IP&#39;
    remote.user = &#39;ä½ çš„æœåŠ¡å™¨ç™»å½•ç”¨æˆ·å&#39;
    remote.port = 22
    remote.password = &#39;ä½ çš„æœåŠ¡å™¨ç™»å½•ç”¨æˆ·å¯†ç &#39;
    remote.allowAnyHosts = true
    return remote
}

pipeline {
    agent {label &#39;master&#39;}
    environment{
        def server = &#39;&#39;;
        def local_work_dir=&quot;./WebApplication&quot;;
        def webpublish_name=&quot;web-publish&quot;;
        def ssh_work_dir=&quot;/root/publish/WebApplication&quot;;
        def ssh_docker_image_name=&quot;dotnet/webdemo&quot;;
        def ssh_docker_container_name=&quot;webdemo&quot;;
    }   
    stages {
        stage(&#39;init-server&#39;){
            steps {
                script {                 
                   server = getHost()                                   
                }
            }
        }
        stage(&#39;git-checkout&#39;) {
            steps {
                git url: &#39;https://github.com/LXD24/DemoReposiroty.git&#39;
            }
        }
        stage(&#39;dotnet-build-publish&#39;){
            steps {
                sh  &#39;&#39;&#39;  
                #åˆ‡æ¢ç›®å½•
                cd ${local_work_dir};
                #è¿˜åŸnugetåŒ…
                dotnet restore;
                #ç¼–è¯‘
                dotnet build;
                #åˆ é™¤ä¹‹å‰å‘å¸ƒæ–‡ä»¶
                cd ./bin;
                rm -rf ${webpublish_name};
                rm -f ${webpublish_name}.tar;
                cd ..;
                #å‘å¸ƒ
                dotnet publish -o ./bin/${webpublish_name};
                #åˆ é™¤é…ç½®æ–‡ä»¶
                cd ./bin/${webpublish_name};
                cp ../../Dockerfile .;
                rm -rf config;
                cd ..;
                #å‹ç¼©
                tar -cvf ${webpublish_name}.tar ${webpublish_name}; 
                 &#39;&#39;&#39;
              echo &#39;---------------- build complete ï¼ ----------------&#39; 
            }
        }
        stage(&#39;ssh-put&#39;){
            steps {
                script {
                    sshPut remote: server, from: &quot;${local_work_dir}/bin/web-publish.tar&quot;, into: &quot;${ssh_work_dir}&quot;
                    echo &#39;---------------- sshput complete ï¼ ----------------&#39; 
                }
            }
        } 
        stage(&#39;ssh-build-docker-image&#39;){
            steps {
                script {
                    sshCommand remote: server, command: &quot;&quot;&quot;
                    # å·¥ä½œç›®å½•
                    cd ${ssh_work_dir}
                    # åˆ é™¤åŸæœ‰å‘å¸ƒæ–‡ä»¶å¤¹
                    rm -rf ${webpublish_name};
                    # è§£å‹
                    tar -xvf ${webpublish_name}.tar;
                    #åˆ é™¤æ–‡ä»¶å‹ç¼©åŒ…
                    rm -f ${webpublish_name}.tar;
                    #åˆ‡æ¢ç”Ÿæˆç›®å½•
                    cd ${webpublish_name}/
                    #å¤‡ä»½é•œåƒ
                    #åœæ­¢å®¹å™¨
                    docker stop ${ssh_docker_container_name};
                    #åˆ é™¤å®¹å™¨
                    docker rm ${ssh_docker_container_name};
                    #åˆ é™¤é•œåƒ
                    docker rmi \$(docker images | grep ${ssh_docker_image_name});
                    #åˆ›å»ºé•œåƒ
                    docker build -t ${ssh_docker_image_name} ./;
                    &quot;&quot;&quot;
                    echo &#39;---------------- ssh-build-docker-image complete ï¼ ----------------&#39; 
                }
            }
        }
        stage(&#39;ssh-docker-run&#39;){
            steps {
                script {
                    sshCommand remote: server, command: &quot;&quot;&quot;
                    docker run -d -p 8001:80 --name  ${ssh_docker_container_name}  ${ssh_docker_image_name}
                    &quot;&quot;&quot;
                    echo &#39;---------------- ssh-docker-run complete ï¼ ----------------&#39; 
                }
            }
        }

    }
}
</code></pre>
<h2 id="æˆæœå±•ç¤º">æˆæœå±•ç¤º ğŸ˜„</h2>
<h3 id="è‡ªç”±é£æ ¼çš„">è‡ªç”±é£æ ¼çš„</h3>
<p><img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š15.png" /></p>
<h3 id="æµæ°´çº¿çš„">æµæ°´çº¿çš„</h3>
<p><img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š16.png" /></p>
<h3 id="dotnet-core-webåº”ç”¨">dotnet core webåº”ç”¨</h3>
<p><img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š17.png" /></p>
<p><img src="./images/æœ¬åœ°Docker Jenkinsæ„å»ºdotnet core webåº”ç”¨åˆ°LinuxæœåŠ¡å™¨ Dockerä¸Š18.png" /></p>
<blockquote>
<p>ç¬¬ä¸€æ¬¡ç ”ç©¶è¿™ä¸ªï¼Œæœ¬æ¥ä»¥ä¸ºæœ¬åœ°ç”¨Dockerç›´æ¥æ‹‰å–ä¸ªjenkinsä¼šç®€å•å¿«é€Ÿä¸€ç‚¹ï¼Œä½†è¿˜æ˜¯èŠ±äº†ä¸å°‘æ—¶é—´~ å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ¬¢è¿è¯„è®ºï¼Œå¤§å®¶ä¸€èµ·å­¦ä¹ è§£å†³ã€‚</p>
</blockquote>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>