<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®ã€æƒé™ç®¡ç†ç³»ç»Ÿã€‘Spring securityï¼ˆä¸‰ï¼‰---è®¤è¯è¿‡ç¨‹ï¼ˆåŸç†è§£æï¼Œdemoï¼‰' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>ã€æƒé™ç®¡ç†ç³»ç»Ÿã€‘Spring securityï¼ˆä¸‰ï¼‰---è®¤è¯è¿‡ç¨‹ï¼ˆåŸç†è§£æï¼Œdemoï¼‰</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»Ccwwç¬”è®°æä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/Ccwwlx/p/12033546.html</div><br>
    <p class="md-end-block md-p"><span class="md-entity md-expand" data-content="&emsp;">&emsp;<span class="md-entity" data-content="&emsp;">&emsp;<span class="md-plain">åœ¨å‰é¢ä¸¤èŠ‚<span class=" md-link"><a href="https://www.cnblogs.com/Ccwwlx/p/11970392.html"><span class="md-plain">Spring security ï¼ˆä¸€ï¼‰æ¶æ„æ¡†æ¶-Componentã€Serviceã€Filteråˆ†æ</span></a><span class="md-plain">å’Œ<span class="md-link"><a href="https://www.cnblogs.com/Ccwwlx/p/11978429.html"><span class="md-plain">Spring Securityï¼ˆäºŒï¼‰--WebSecurityConfigureré…ç½®ä»¥åŠfilteré¡ºåº</span></a><span class="md-plain">ä¸ºSpring Securityè®¤è¯ä½œå¥½äº†å‡†å¤‡ï¼Œå¯ä»¥è®©æˆ‘ä»¬æ›´å¥½çš„ç†è§£è®¤è¯è¿‡ç¨‹ä»¥åŠé¡¹ç›®ä»£ç ç¼–å†™ã€‚</span></span></span></span></span></span></span></p>
<h2 class="md-end-block md-heading md-focus"><span class="md-plain md-expand">1.è®¤è¯è¿‡ç¨‹å·¥ä½œæµç¨‹</span></h2>
<p class="md-end-block md-p"><span class="md-plain">è®¤è¯å·¥ä½œæµç¨‹ï¼š</span>&nbsp;&nbsp;</p>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;"> AbstractAuthenticationProcessingFilter
    doFilter()(attemptAuthentication()è·å–Authenticationå®ä½“)
        </span>-&gt;<span style="color: #000000;">UsernamePasswordAuthenticationFilterï¼ˆAbstractAuthenticationProcessingFilterçš„å­ç±»ï¼‰
            attemptAuthentication() ï¼ˆåœ¨UsernamePasswordAuthenticationToken()ä¸­å°†username å’Œ password ç”Ÿæˆ UsernamePasswordAuthenticationTokenå¯¹è±¡,getAuthenticationManager().authenticateè¿›è¡Œè®¤è¯ä»¥åŠè¿”å›è·å–Authenticationå®ä½“ï¼‰
                </span>-&gt;<span style="color: #000000;">AuthenticationManager   
             </span>-&gt;<span style="color: #000000;">ProviderManager()ï¼ˆAuthenticationManageræ¥å£å®ç°ï¼‰
                     authenticate()(AuthenticationProvider.authenticate()è¿›è¡Œè®¤è¯å¹¶è·å–Authenticationå®ä½“)
                        </span>-&gt;<span style="color: #000000;">AbstractUserDetailsAuthenticationProvider(å†…ç½®ç¼“å­˜æœºåˆ¶ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯å°±è°ƒç”¨retrieveUser()è·å–ç”¨æˆ·)
                            authenticate()  (è·å–Authenticationå®ä½“éœ€è¦userDetailsï¼Œåœ¨ç¼“å­˜ä¸­æˆ–è€…retrieveUser()è·å–userDetailsï¼›éªŒè¯additionalAuthenticationChecks()ï¼›     createSuccessAuthentication()ç”ŸæˆAuthenticationå®ä½“)
                </span>-&gt;<span style="color: #000000;">DaoAuthenticationProvider
                    retrieveUser()  (è°ƒç”¨è‡ªå®šä¹‰UserDetailsServiceä¸­loadUserByUsername()åŠ è½½userDetails)
                    </span>-&gt;<span style="color: #000000;">UserDetailsService   
                        loadUserByUsername()ï¼ˆè·å–userDetailsï¼‰</span></pre>
</div>
<p class="md-end-block md-p"><span class="md-plain">å…·ä½“æµç¨‹è¯·çœ‹ä¸‹é¢å°èŠ‚ã€‚</span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">1.1ï¼šè¯·æ±‚é¦–å…ˆç»è¿‡è¿‡æ»¤å™¨AbstractAuthenticationProcessingFilterä»¥åŠUsernamePasswordAuthenticationFilterè¿›è¡Œå¤„ç†</span></h3>
<p class="md-end-block md-p"><span class="md-entity" data-content="&emsp;">&emsp;<span class="md-entity" data-content="&emsp;">&emsp;<span class="md-plain">å½“è¯·æ±‚æ¥ä¸´æ—¶ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯·æ±‚å…ˆç»è¿‡AbstractAuthenticationProcessingFilterçš„å­ç±»UsernamePasswordAuthenticationFilterè¿‡æ»¤å™¨ã€‚åœ¨UsernamePasswordAuthenticationFilterè¿‡æ»¤å™¨è°ƒç”¨attemptAuthentication()æ–¹æ³•ç°å®ä¸»è¦çš„ä¸¤æ­¥è¿‡ç¨‹ï¼š</span></span></span></p>
<ol class="ol-list" start="">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">åˆ›å»ºæ‹¥æœ‰ç”¨æˆ·çš„è¯¦æƒ…ä¿¡æ¯çš„Authenticationå¯¹è±¡ï¼Œåœ¨é»˜è®¤çš„UsernamePasswordAuthenticationFilterä¸­å°†åˆ›å»ºUsernamePasswordAuthenticationTokençš„Authenticationå¯¹è±¡ï¼›</span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">AuthenticationManagerè°ƒç”¨authenticate()æ–¹æ³•è¿›è¡Œè®¤è¯è¿‡ç¨‹ï¼Œåœ¨é»˜è®¤æƒ…å†µï¼Œä½¿ç”¨ProviderManagerç±»è¿›è¡Œè®¤è¯ã€‚ </span></p>
</li>
</ol>
<p class="md-end-block md-p"><span class="md-plain">UsernamePasswordAuthenticationFilteræºç åˆ†æï¼š</span></p>
<div class="cnblogs_code">
<pre><code>    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> UsernamePasswordAuthenticationFilter <span style="color: #0000ff;">extends</span><span style="color: #000000;">
        AbstractAuthenticationProcessingFilter {
        ....
        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Authentication attemptAuthentication(HttpServletRequest request,
            HttpServletResponse response) </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> AuthenticationException {
            .....
            </span><span style="color: #008000;">//</span><span style="color: #008000;">1.åˆ›å»ºæ‹¥æœ‰ç”¨æˆ·çš„è¯¦æƒ…ä¿¡æ¯çš„Authenticationå¯¹è±¡</span>
        UsernamePasswordAuthenticationToken authRequest = <span style="color: #0000ff;">new</span><span style="color: #000000;"> UsernamePasswordAuthenticationToken(
                username, password);
â€‹
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Allow subclasses to set the "details" property</span>
<span style="color: #000000;">        setDetails(request, authRequest);
                </span><span style="color: #008000;">//</span><span style="color: #008000;">2.AuthenticationManagerè¿›è¡Œè®¤è¯</span>
        <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.getAuthenticationManager().authenticate(authRequest);
    }
    ...
   } </span><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab"><span class="cm-tab">&nbsp;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
<h3 class="md-end-block md-heading"><span class="md-plain">1.2è¯·æ±‚ç»è¿‡è¿‡æ»¤å™¨å¤„ç†ä¹‹åï¼Œåœ¨AuthenticationManagerä»¥åŠProviderManagerè®¤è¯</span></h3>
<p class="md-end-block md-p"><span class="md-entity" data-content="&emsp;">&emsp;<span class="md-entity" data-content="&emsp;">&emsp;<span class="md-plain">åœ¨UsernamePasswordAuthenticationFilterä¸­çœ‹å‡ºï¼Œå°†è°ƒç”¨AuthenticationManageræ¥å£çš„authenticate()æ–¹æ³•è¿›è¡Œè¯¦ç»†è®¤è¯ã€‚é»˜è®¤æƒ…å†µå°†ä½¿ç”¨AuthenticationManagerå­ç±»ProviderManagerçš„authenticate()è¿›è¡Œè®¤è¯ï¼Œå¯ä»¥åˆ†æˆä¸‰ä¸ªä¸»è¦è¿‡ç¨‹ï¼š</span></span></span></p>
<ol class="ol-list" start="">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">AuthenticationProvide.authenticate()è¿›è¡Œè®¤è¯ï¼Œé»˜è®¤ä¸‹ï¼Œå°†ä½¿ç”¨AbstractUserDetailsAuthenticationProviderè¿›è¡Œè®¤è¯ï¼›</span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">è®¤è¯æˆåŠŸåï¼Œä»authenticationä¸­åˆ é™¤å‡­æ®å’Œå…¶ä»–æœºå¯†æ•°æ®ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸æˆ–è€…è®¤è¯å¤±è´¥ï¼›</span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">å‘å¸ƒè®¤è¯æˆåŠŸäº‹ä»¶ï¼Œå¹¶å°†Authenticationå¯¹è±¡ä¿å­˜åˆ°security contextä¸­ã€‚</span></p>
</li>
</ol>
<p class="md-end-block md-p"><span class="md-plain">ProviderManageræºç åˆ†æï¼š </span></p>
<div class="cnblogs_code">
<pre><code><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ProviderManager <span style="color: #0000ff;">implements</span><span style="color: #000000;"> AuthenticationManager, MessageSourceAware,
    InitializingBean {
    ...
        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Authentication authenticate(Authentication authentication)
            </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> AuthenticationException {
                ...
                </span><span style="color: #008000;">//</span><span style="color: #008000;">AuthenticationProviderä¾æ¬¡è¿›è¡Œè®¤è¯</span>
        <span style="color: #0000ff;">for</span><span style="color: #000000;"> (AuthenticationProvider provider : getProviders()) {
                ...
            </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">1.1è¿›è¡Œè®¤è¯ï¼Œå¹¶è¿”å›Authenticationå¯¹è±¡</span>
                result =<span style="color: #000000;"> provider.authenticate(authentication);
â€‹
                </span><span style="color: #0000ff;">if</span> (result != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                    copyDetails(authentication, result);
                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
                }
            }
                ...
            </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (AuthenticationException e) {
                lastException </span>=<span style="color: #000000;"> e;
            }
        }
        </span><span style="color: #0000ff;">if</span> (result == <span style="color: #0000ff;">null</span> &amp;&amp; parent != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Allow the parent to try.</span>
            <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">1.2å¦‚æœ1.1è®¤è¯ä¸­æ²¡æœ‰ä¸€ä¸ªéªŒè¯é€šè¿‡ï¼Œåˆ™ä½¿ç”¨çˆ¶ç±»å‹AuthenticationManagerè¿›è¡ŒéªŒè¯</span>
                result =<span style="color: #000000;"> parent.authenticate(authentication);
            }
            </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (ProviderNotFoundException e) {
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> ignore as we will throw below if no other exception occurred prior to
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> calling parent and the parent
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> may throw ProviderNotFound even though a provider in the child already
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> handled the request</span>
<span style="color: #000000;">            }
            </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (AuthenticationException e) {
                lastException </span>=<span style="color: #000000;"> e;
            }
        }
                </span><span style="color: #008000;">//</span><span style="color: #008000;">2.ä»authenticationä¸­åˆ é™¤å‡­æ®å’Œå…¶ä»–æœºå¯†æ•°æ®</span>
        <span style="color: #0000ff;">if</span> (result != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (eraseCredentialsAfterAuthentication
                    </span>&amp;&amp; (result <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> CredentialsContainer)) {
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> Authentication is complete. Remove credentials and other secret data
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> from authentication</span>
<span style="color: #000000;">                ((CredentialsContainer) result).eraseCredentials();
            }
              </span><span style="color: #008000;">//</span><span style="color: #008000;">3.å‘å¸ƒè®¤è¯æˆåŠŸäº‹ä»¶ï¼Œå¹¶å°†Authenticationå¯¹è±¡ä¿å­˜åˆ°security contextä¸­</span>
<span style="color: #000000;">            eventPublisher.publishAuthenticationSuccess(result);
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> result;
        }
    }</span></pre>
</div>
<h3 class="md-end-block md-heading"><span class="md-plain">1.3 è®¤è¯è¿‡ç¨‹è¯¦ç»†å¤„ç†ï¼šAuthenticationProviderã€AbstractUserDetailsAuthenticationProviderä»¥åŠDaoAuthenticationProvider</span></h3>
<p class="md-end-block md-p"><span class="md-entity" data-content="&emsp;">&emsp;<span class="md-entity" data-content="&emsp;">&emsp;<span class="md-plain">åœ¨é»˜è®¤è®¤è¯è¯¦ç»†å¤„ç†è¿‡ç¨‹ä¸­ï¼ŒAuthenticationProviderè®¤è¯ç”±AbstractUserDetailsAuthenticationProvideræŠ½è±¡ç±»ä»¥åŠAbstractUserDetailsAuthenticationProviderçš„å­ç±»DaoAuthenticationProviderè¿›è¡Œæ–¹æ³•é‡å†™ååŠ©å…±åŒå·¥ä½œè¿›è¡Œè®¤è¯çš„ã€‚ä¸»è¦å¯ä»¥åˆ†æˆä»¥ä¸‹æ­¥éª¤ï¼š </span></span></span></p>
<ol class="ol-list" start="">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">è·å–ç”¨æˆ·ä¿¡æ¯UserDetailsï¼Œé¦–å…ˆä»ç¼“å­˜ä¸­è¯»å–ä¿¡æ¯ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰çš„åŒ–ï¼Œåœ¨UserDetailsServiceä¸­åŠ è½½ï¼Œå…¶æœ€ä¸»è¦å¯ä»¥ä»æˆ‘ä»¬è‡ªå®šä¹‰çš„UserDetailsServiceè¿›è¡Œè¯»å–ç”¨æˆ·ä¿¡æ¯UserDetailsï¼›</span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">éªŒè¯ä¸‰æ­¥èµ°ï¼š<span class="md-linebreak"> <span class="md-linebreak-mark"> <span class="md-plain">1). preAuthenticationChecks </span></span></span></span></p>
<p class="md-end-block md-p"><span class="md-plain">2). additionalAuthenticationChecksï¼šä½¿ç”¨PasswordEncoder.matches()æ–¹æ³•è¿›è¡Œè®¤è¯ï¼Œå…¶éªŒè¯æ–¹å¼ä¸­éªŒè¯æ•°æ®å·²ç»è¿‡PasswordEncoderç®—æ³•åŠ å¯†ï¼Œå¯ä»¥é€šè¿‡å®ç°PasswordEncoderæ¥å£æ¥å®šä¹‰ç®—æ³•åŠ å¯†æ–¹å¼ã€‚ </span></p>
<p class="md-end-block md-p"><span class="md-plain">3). postAuthenticationChecks</span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">å°†å·²é€šè¿‡éªŒè¯çš„ç”¨æˆ·ä¿¡æ¯å°è£…æˆ UsernamePasswordAuthenticationTokenå¯¹è±¡å¹¶è¿”å›ï¼›è¯¥å¯¹è±¡å°è£…äº†ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œä»¥åŠç›¸åº”çš„æƒé™ä¿¡æ¯ã€‚ </span></p>
</li>
</ol>
<p class="md-end-block md-p"><span class="md-entity" data-content="&emsp;">&emsp;<span class="md-entity" data-content="&emsp;">&emsp;<span class="md-plain">AbstractUserDetailsAuthenticationProviderä¸»è¦åŠŸèƒ½æä¾›authenticate()è®¤è¯æ–¹æ³•ä»¥åŠç»™DaoAuthenticationProvideré‡å†™æ–¹æ³•æºç åˆ†æï¼š</span></span></span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span> &nbsp;</span></pre>
<div class="cnblogs_code">
<pre><code> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> AbstractUserDetailsAuthenticationProvider <span style="color: #0000ff;">implements</span><span style="color: #000000;">
        AuthenticationProvider, InitializingBean, MessageSourceAware {
        ...
        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Authentication authenticate(Authentication authentication)
        </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> AuthenticationException {
                   ...
            </span><span style="color: #0000ff;">boolean</span> cacheWasUsed = <span style="color: #0000ff;">true</span><span style="color: #000000;">;
            </span><span style="color: #008000;">//</span><span style="color: #008000;">1.1è·å–ç¼“å­˜ä¸­UserDetailsä¿¡æ¯</span>
            UserDetails user = <span style="color: #0000ff;">this</span><span style="color: #000000;">.userCache.getUserFromCache(username);
                  </span><span style="color: #008000;">//</span><span style="color: #008000;">1.2 å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ä¿¡æ¯ï¼Œä»UserDetailsServiceä¸­è·å–</span>
            <span style="color: #0000ff;">if</span> (user == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                cacheWasUsed </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    
                </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                        </span><span style="color: #008000;">//</span><span style="color: #008000;">ä½¿ç”¨DaoAuthenticationProviderä¸­é‡å†™çš„æ–¹æ³•å»è·å–ä¿¡æ¯</span>
                    user =<span style="color: #000000;"> retrieveUser(username,
                            (UsernamePasswordAuthenticationToken) authentication);
                }</span><span style="color: #0000ff;">catch</span><span style="color: #000000;">{
                ...
                }
                ...
            </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">è¿›è¡Œæ£€éªŒè®¤è¯</span>
<span style="color: #000000;">                preAuthenticationChecks.check(user);
                additionalAuthenticationChecks(user,
                        (UsernamePasswordAuthenticationToken) authentication);
            }</span><span style="color: #0000ff;">catch</span><span style="color: #000000;">{
            ...
            }
                ...
            postAuthenticationChecks.check(user);
                   ....
                   </span><span style="color: #008000;">//</span><span style="color: #008000;"> å°†å·²é€šè¿‡éªŒè¯çš„ç”¨æˆ·ä¿¡æ¯å°è£…æˆ UsernamePasswordAuthenticationTokenå¯¹è±¡å¹¶è¿”å›</span>
            <span style="color: #0000ff;">return</span><span style="color: #000000;"> createSuccessAuthentication(principalToReturn, authentication, user);
    }</span></pre>
</div>
<p>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-entity" data-content="&emsp;">&emsp;<span class="md-entity" data-content="&emsp;">&emsp;<span class="md-plain">DaoAuthenticationProvideråŠŸèƒ½ä¸»è¦ä¸ºè®¤è¯å‡­è¯åŠ å¯†PasswordEncoderï¼Œä»¥åŠé‡å†™AbstractUserDetailsAuthenticationProvideræŠ½è±¡ç±»çš„retrieveUserã€additionalAuthenticationChecksæ–¹æ³•ï¼Œå…¶ä¸­retrieveUserä¸»è¦æ˜¯è·å–UserDetailsä¿¡æ¯ï¼Œæºç åˆ†æ</span></span></span></p>
<div class="cnblogs_code">
<pre><code>    <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> UserDetails retrieveUser(String username,
        UsernamePasswordAuthenticationToken authentication)
        </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> AuthenticationException {
    prepareTimingAttackProtection();
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
            </span><span style="color: #008000;">//</span><span style="color: #008000;">æ ¹æ®UserDetailsServiceè·å–UserDetailsä¿¡æ¯ï¼Œä»è‡ªå®šä¹‰çš„UserDetailsServiceè·å–</span>
        UserDetails loadedUser = <span style="color: #0000ff;">this</span><span style="color: #000000;">.getUserDetailsService().loadUserByUsername(username);
        </span><span style="color: #0000ff;">if</span> (loadedUser == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> InternalAuthenticationServiceException(
                    </span>"UserDetailsService returned null, which is an interface contract violation"<span style="color: #000000;">);
        }
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> loadedUser;
    }
    </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (UsernameNotFoundException ex) {
        mitigateAgainstTimingAttack(authentication);
        </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> ex;
    }
    </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InternalAuthenticationServiceException ex) {
        </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> ex;
    }
    </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex) {
        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> InternalAuthenticationServiceException(ex.getMessage(), ex);
    }
}</span></pre>
</div>
<p class="md-end-block md-p"><span class="md-plain">additionalAuthenticationChecksä¸»è¦ä½¿ç”¨PasswordEncoderè¿›è¡Œå¯†ç éªŒè¯ï¼Œæºç åˆ†æï¼š</span></p>
<div class="cnblogs_code">
<pre><code><span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> additionalAuthenticationChecks(UserDetails userDetails,
        UsernamePasswordAuthenticationToken authentication)
        </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> AuthenticationException {
    </span><span style="color: #0000ff;">if</span> (authentication.getCredentials() == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        logger.debug(</span>"Authentication failed: no credentials provided"<span style="color: #000000;">);
â€‹
        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> BadCredentialsException(messages.getMessage(
                </span>"AbstractUserDetailsAuthenticationProvider.badCredentials"<span style="color: #000000;">,
                </span>"Bad credentials"<span style="color: #000000;">));
    }
â€‹
    String presentedPassword </span>=<span style="color: #000000;"> authentication.getCredentials().toString();
        </span><span style="color: #008000;">//</span><span style="color: #008000;">è¿›è¡Œå¯†ç éªŒè¯</span>
    <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">passwordEncoder.matches(presentedPassword, userDetails.getPassword())) {
        logger.debug(</span>"Authentication failed: password does not match stored value"<span style="color: #000000;">);
â€‹
        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> BadCredentialsException(messages.getMessage(
                </span>"AbstractUserDetailsAuthenticationProvider.badCredentials"<span style="color: #000000;">,
                </span>"Bad credentials"<span style="color: #000000;">));
    }
}</span></pre>
</div>
<p>&nbsp;</p>
<h3 class="md-end-block md-heading"><span class="md-plain">1.4 è®¤è¯ä¸­æ‰€éœ€çš„è®¤è¯å‡­è¯è·å–ï¼šUserDetailsService</span></h3>
<p class="md-end-block md-p"><span class="md-entity" data-content="&emsp;">&emsp;<span class="md-entity" data-content="&emsp;">&emsp;<span class="md-plain">åœ¨è®¤è¯ä¸­å¿…é¡»è·å–è®¤è¯å‡­è¯ï¼Œä»UserDetailsServiceè·å–åˆ°è®¤è¯å‡­è¯ï¼ŒUserDetailsServiceæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</span></span></span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span>UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;</span></pre>
<p class="md-end-block md-p"><span class="md-plain">é€šè¿‡ç”¨æˆ·å username è°ƒç”¨æ–¹æ³• loadUserByUsername è¿”å›äº†ä¸€ä¸ªUserDetailsæ¥å£å¯¹è±¡ï¼š</span></p>
<div class="cnblogs_code">
<pre><code><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span> UserDetails <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Serializable {
    </span><span style="color: #008000;">//</span><span style="color: #008000;">1.æƒé™é›†åˆ</span>
    Collection&lt;? <span style="color: #0000ff;">extends</span> GrantedAuthority&gt;<span style="color: #000000;"> getAuthorities();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">2.å¯†ç   </span>
<span style="color: #000000;">    String getPassword();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">3.ç”¨æˆ·å</span>
<span style="color: #000000;">    String getUsername();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">4.ç”¨æˆ·æ˜¯å¦è¿‡æœŸ</span>
    <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isAccountNonExpired();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">5.æ˜¯å¦é”å®š    </span>
    <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isAccountNonLocked();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">6.ç”¨æˆ·å¯†ç æ˜¯å¦è¿‡æœŸ    </span>
    <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isCredentialsNonExpired();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">7.è´¦å·æ˜¯å¦å¯ç”¨ï¼ˆå¯ç†è§£ä¸ºæ˜¯å¦åˆ é™¤ï¼‰</span>
    <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isEnabled();
}</span></pre>
</div>
<p class="md-end-block md-p"><span class="md-plain">æˆ‘ä»¬é€šè¿‡å®ç°UserDetailsServiceè‡ªå®šä¹‰è·å–UserDetailsç±»ï¼Œå¯ä»¥ä»ä¸åŒæ•°æ®æºä¸­è·å–è®¤è¯å‡­è¯ã€‚</span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">1.5 æ€»ç»“</span></h3>
<p class="md-end-block md-p"><span class="md-plain">æ€»ç»“<span class="md-link"><a href="https://www.cnblogs.com/Ccwwlx/p/11978429.html"><span class="md-plain">Spring Securityï¼ˆäºŒï¼‰--WebSecurityConfigureré…ç½®ä»¥åŠfilteré¡ºåº</span></a><span class="md-plain">å’Œæœ¬èŠ‚Spring securityï¼ˆä¸‰ï¼‰æƒ³è¦å®ç°ç®€å•è®¤è¯è¿‡ç¨‹ï¼š </span></span></span></p>
<ol class="ol-list" start="">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">ç¬¬ä¸€æ­¥ï¼šé…ç½®WebSecurityConfig</span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">ç¬¬äºŒæ­¥ï¼š å®ç°è‡ªå®šä¹‰UserDetailsServiceï¼Œè‡ªå®šä¹‰ä»æ•°æ®æºç è·å–è®¤è¯å‡­è¯ã€‚</span></p>
</li>
</ol>
<h2 class="md-end-block md-heading"><span class="md-plain">2 Spring bootä¸Spring securityæ•´åˆ </span></h2>
<h3 class="md-end-block md-heading"><span class="md-plain">2.1é…ç½®WebSecurityConfig</span></h3>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;">@Configuration
@EnableWebSecurity
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SecurityConfig <span style="color: #0000ff;">extends</span><span style="color: #000000;"> WebSecurityConfigurerAdapter {
  @Override
  </span><span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> configure(HttpSecurity http) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub
        </span><span style="color: #008000;">//</span><span style="color: #008000;">super.configure(http);</span>
<span style="color: #000000;">        http .csrf().disable()
             .authorizeRequests()
             .anyRequest().authenticated()
              .and()
             .formLogin()
                .loginPage(</span>"/login"<span style="color: #000000;">)
                .loginProcessingUrl(</span>"/login/form"<span style="color: #000000;">)
                .failureUrl(</span>"/login-error"<span style="color: #000000;">)
                .permitAll()  </span><span style="color: #008000;">//</span><span style="color: #008000;">è¡¨å•ç™»å½•ï¼ŒpermitAll()è¡¨ç¤ºè¿™ä¸ªä¸éœ€è¦éªŒè¯ ç™»å½•é¡µé¢ï¼Œç™»å½•å¤±è´¥é¡µé¢</span>
<span style="color: #000000;">              .and()
                .logout().permitAll();
        }
}</span></pre>
</div>
<h3 class="md-end-block md-heading"><span class="md-plain">2.2 UserDetailsServiceå®ç°</span></h3>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;">@service
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> CustomUserService <span style="color: #0000ff;">implements</span><span style="color: #000000;"> UserDetailsService {
 @Autowired
 </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> UserInfoMapper userInfoMapper;
 @Autowired
 </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> PermissionInfoMapper permissionInfoMapper;
 @Autowired
 </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> BCryptPasswordEncoderService bCryptPasswordEncoderService;
  @Override
  </span><span style="color: #0000ff;">public</span> UserDetails loadUserByUsername(String username) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> UsernameNotFoundException {
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub
        </span><span style="color: #008000;">//</span><span style="color: #008000;">è¿™é‡Œå¯ä»¥å¯ä»¥é€šè¿‡usernameï¼ˆç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·åï¼‰ç„¶ååˆ°æ•°æ®åº“ä¸­æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶æ„å»ºæˆæˆ‘ä»¬è‡ªå·±çš„UserInfoæ¥è¿”å›ã€‚</span>
        UserInfoDTO user =<span style="color: #000000;"> userInfoMapper.getUserInfoByUserName(username);
         </span><span style="color: #0000ff;">if</span> (user != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        List</span>&lt;PermissionInfoDTO&gt; permissionInfoDTOS =<span style="color: #000000;"> permissionInfoMapper.findByAdminUserId(userInfo.getId());
        List</span>&lt;GrantedAuthority&gt; grantedAuthorityList = <span style="color: #0000ff;">new</span> ArrayList&lt;&gt;<span style="color: #000000;">();
        </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (PermissionInfoDTO permissionInfoDTO : permissionInfoDTOS) {
            </span><span style="color: #0000ff;">if</span> (permissionInfoDTO != <span style="color: #0000ff;">null</span> &amp;&amp; permissionInfoDTO.getPermissionName() != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                GrantedAuthority grantedAuthority </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> SimpleGrantedAuthority(
                        permissionInfoDTO.getPermissionName());
                grantedAuthorityList.add(grantedAuthority);
                 }
            }
             </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> User(userInfo.getUserName(), bCryptPasswordEncoderService.encode(userInfo.getPasswaord()), grantedAuthorityList);
         }</span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> UsernameNotFoundException("admin" + username + "do not exist"<span style="color: #000000;">);
         }
    }
}</span></pre>
</div>
<p class="md-end-block md-p"><span class="md-plain">å¾€æœŸæ–‡ç« :</span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-link"><a href="https://www.cnblogs.com/Ccwwlx/p/11970392.html"><span class="md-plain">Spring security ï¼ˆä¸€ï¼‰æ¶æ„æ¡†æ¶-Componentã€Serviceã€Filteråˆ†æ</span></a></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-link"><a href="https://www.cnblogs.com/Ccwwlx/p/11978429.html"><span class="md-plain">Spring Securityï¼ˆäºŒï¼‰--WebSecurityConfigureré…ç½®ä»¥åŠfilteré¡ºåº</span></a></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">...</span></p>
</li>
</ul>
<blockquote>
<p class="md-end-block md-p"><span class="md-plain">å„ä½çœ‹å®˜è¿˜å¯ä»¥å—ï¼Ÿå–œæ¬¢çš„è¯ï¼ŒåŠ¨åŠ¨æ‰‹æŒ‡ç‚¹ä¸ªèµğŸ’—ï¼Œç‚¹ä¸ªå…³æ³¨å‘—ï¼ï¼è°¢è°¢æ”¯æŒï¼</span></p>
<p class="md-end-block md-p"><span class="md-plain">ä¹Ÿæ¬¢è¿å…³æ³¨å…¬ä¼—å·ã€<span><strong>Ccwwç¬”è®°</strong><span class="md-plain">ã€‘ï¼ŒåŸåˆ›æŠ€æœ¯æ–‡ç« ç¬¬ä¸€æ—¶é—´æ¨å‡º</span></span></span></p>
<p class="md-end-block md-p">&nbsp;<img src="./images/ã€æƒé™ç®¡ç†ç³»ç»Ÿã€‘Spring securityï¼ˆä¸‰ï¼‰---è®¤è¯è¿‡ç¨‹ï¼ˆåŸç†è§£æï¼Œdemoï¼‰0.png" alt="" /></p>
</blockquote>
<pre><code><span>getAuthenticationManager().authenticateè¿›è¡Œè®¤è¯ä»¥åŠè¿”å›è·å–Authenticationå®ä½“ï¼‰</span></pre>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>